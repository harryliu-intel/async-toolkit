// Autogenerated Jamon implementation
// /nfs/site/disks/wdisk.55/rliu68/reg-rrc-1/shared/java/src/./com/fulcrummicro/hw/verification/chip/mgmt/registers/templates/Specman.jamon

package com.fulcrummicro.hw.verification.chip.mgmt.registers.templates;

// 3, 1
import java.util.ArrayList;
// 4, 1
import java.util.Collection;
// 5, 1
import com.fulcrummicro.util.misc.Utility;
// 6, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.*;
// 7, 1
import com.fulcrummicro.hw.verification.lib.bitarray.LittleEndianBitArray;

public class SpecmanImpl
  extends com.fulcrummicro.util.jamon.timestampImpl
  implements com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Specman.Intf

{
  private final Collection<RegisterBase> bases;
  private final Collection<Register> regs;
  private final String chip;
  private final boolean virtual;
  // 10, 1
  
private static final String RESERVED = "reserved";
private static final String RESERVED_TYPE = "RES_S";
private static final int WORD_SIZE = 32;

private static class Field {
    public int len;
    public int pos;
    public String desc;
    public RegisterType type;
    public LittleEndianBitArray def;
    public Field(int len, int pos, String desc, RegisterType type,
                 LittleEndianBitArray def) {
        this.len = len;
        this.pos = pos;
        this.desc = desc;
        this.type = type;
        this.def = def;
    }
    public Field(RegisterField f, LittleEndianBitArray def) {
        this(f.len, f.pos, f.desc, f.type, def);
    }
    public int lo() {
        return pos;
    }
    public int hi() {
        return pos + len - 1;
    }
    public Field[] split(int size) {
        int len2 = len - size;
        return new Field[] {
            new Field(size, pos, desc, type, def.getSlice(0, size)),
            new Field(len2, pos + size, desc, type, def.getSlice(size, len2))
        };
    }
    public Field shift(int size) {
        return new Field(len, pos + size, desc, type, def);
    }
}

private static ArrayList<Field> pad(Register r, int bits) {
    LittleEndianBitArray rdef = new LittleEndianBitArray(r.getBitWidth() + 1);
    rdef.set(r.getDefault(0));

    ArrayList<Field> padded = new ArrayList<Field>();
    int reserved = 0;
    int last = 0;
    for (RegisterField rf : r.getSortedFields(true, false, false)) {
        LittleEndianBitArray def = rdef.getSlice(rf.pos, rf.len);
        Field f;
        if (rf.type.equals(RegisterType.RV)) {
            f = new Field(rf.len, rf.pos, RESERVED + (reserved++), rf.type,
                          def);
        } else {
            f = new Field(rf, def);
        }
        padded.add(f);
        last = rf.pos + rf.len - 1;
    }
    int left = last % bits;
    if (left != bits - 1) {
        int pad = bits - 1 - left;
        padded.add(new Field(pad, last + 1, RESERVED + (reserved++),
                             RegisterType.RV, new LittleEndianBitArray(pad)));
    }
    return padded;
}

private static ArrayList<ArrayList<Field>> wordify(ArrayList<Field> fields,
                                                   int bits) {
    ArrayList<ArrayList<Field>> result = new ArrayList<ArrayList<Field>>();
    ArrayList<Field> curr = new ArrayList<Field>();
    for (Field field : fields) {
        Field f = field;
        while (f.lo() / bits != f.hi() / bits) {
            int left = f.lo() % bits;
            Field[] parts = f.split(bits - left);
            curr.add(parts[0].shift(-result.size() * bits));
            result.add(curr);
            curr = new ArrayList<Field>();
            f = parts[1];
        }
        curr.add(f.shift(-result.size() * bits));
        if (f.hi() % bits == bits - 1) {
            result.add(curr);
            curr = new ArrayList<Field>();
        }
    }
    return result;
}

  protected static com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Specman.ImplData __jamon_setOptionalArguments(com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Specman.ImplData p_implData)
  {
    com.fulcrummicro.util.jamon.timestampImpl.__jamon_setOptionalArguments(p_implData);
    return p_implData;
  }
  public SpecmanImpl(org.jamon.TemplateManager p_templateManager, com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Specman.ImplData p_implData)
  {
    super(p_templateManager, __jamon_setOptionalArguments(p_implData));
    bases = p_implData.getBases();
    regs = p_implData.getRegs();
    chip = p_implData.getChip();
    virtual = p_implData.getVirtual();
  }
  
  @Override protected void child_render_1(final java.io.Writer jamonWriter)
    throws java.io.IOException
  {
    // 121, 9
    jamonWriter.write("-- \n-- INTEL TOP SECRET\n-- Copyright ");
    // 124, 14
    {
      // 124, 14
      __jamon_innerUnit__copyright_year(jamonWriter, __jamon__get_Method_Opt_creationYear_default());
    }
    // 124, 35
    jamonWriter.write(" Intel Corporation. All Rights Reserved.\n-- \n-- THIS FILE IS AUTOMATICALLY GENERATED - DO NOT MODIFY.\n-- Last Updated ");
    // 127, 17
    {
      // 127, 17
      __jamon_innerUnit__timestamp(jamonWriter);
    }
    // 127, 33
    jamonWriter.write("\n-- \n\n");
    // 130, 1
    String group = "PEPS"; 
    // 131, 1
    for (Register reg : regs )
    {
      // 132, 1
      
ArrayList<ArrayList<Field>> parts = wordify(pad(reg, WORD_SIZE), WORD_SIZE);
int baseAddr = reg.getAddressSafe();
int count = 0;

      // 137, 1
      for (ArrayList<Field> part : parts )
      {
        // 138, 1
        
String name = reg.getName();
int addr = ((baseAddr & ((1 << 20) - 1)) + count) * 4;
String addrStr = "0x" + String.format("%x", addr);
if (parts.size() > 1) name += "_" + (count++);

        // 144, 1
        jamonWriter.write("create ");
        // 145, 1
        if (reg.getNumEntries() > 1 )
        {
          // 145, 32
          jamonWriter.write("csrs_list_f ");
          // 146, 13
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(name), jamonWriter);
          // 146, 23
          jamonWriter.write("/0..");
          // 146, 27
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(reg.getNumEntries() * reg.getNumEntries1() * reg.getNumEntries2() - 1), jamonWriter);
          // 146, 102
          jamonWriter.write("/, skip ");
          // 147, 6
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(reg.getEntrySpace() * 4), jamonWriter);
          // 147, 35
          jamonWriter.write(", base_address ");
        }
        // 149, 1
        else
        {
          // 149, 8
          jamonWriter.write("csr ");
          // 150, 5
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(name), jamonWriter);
          // 150, 15
          jamonWriter.write(", RO, address ");
        }
        // 154, 1
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(addrStr), jamonWriter);
        // 154, 14
        jamonWriter.write(" to project_regs/");
        // 154, 31
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(group), jamonWriter);
        // 154, 42
        jamonWriter.write("/ {\n");
        // 155, 1
        if (virtual )
        {
          // 155, 16
          jamonWriter.write("    virtual func (index) address ");
          // 156, 34
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(addrStr), jamonWriter);
          // 156, 47
          jamonWriter.write(";\n    keep enable_virtual_access == TRUE;\n");
        }
        // 159, 1
        for (Field f : part )
        {
          // 160, 1
          {
            // 160, 1
            __jamon_innerUnit____field(jamonWriter, f );
          }
        }
        // 161, 8
        jamonWriter.write("};\n");
      }
    }
  }
  
  
  // 102, 1
  private void __jamon_innerUnit____field(final java.io.Writer jamonWriter, final Field f)
    throws java.io.IOException
  {
    // 106, 1
    
String type = f.type.equals(RegisterType.RV) ? RESERVED_TYPE
                                             : f.type.toString();

    // 109, 9
    jamonWriter.write("    csr_field ");
    // 110, 15
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.desc), jamonWriter);
    // 110, 27
    jamonWriter.write(", bits /");
    // 111, 7
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.lo()), jamonWriter);
    // 111, 19
    jamonWriter.write("..");
    // 111, 21
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.hi()), jamonWriter);
    // 111, 33
    jamonWriter.write("/, ");
    // 112, 1
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(type), jamonWriter);
    // 112, 11
    jamonWriter.write(", default 0x");
    // 113, 11
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.def.toHexString()), jamonWriter);
    // 113, 36
    jamonWriter.write(";\n");
  }
  
  
}
