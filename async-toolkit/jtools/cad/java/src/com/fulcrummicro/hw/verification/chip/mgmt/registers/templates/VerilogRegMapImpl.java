// Autogenerated Jamon implementation
// /nfs/site/disks/wdisk.53/kedunckl/p4wd/reg-main-1/shared/java/src/./com/fulcrummicro/hw/verification/chip/mgmt/registers/templates/VerilogRegMap.jamon

package com.fulcrummicro.hw.verification.chip.mgmt.registers.templates;

// 3, 1
import java.util.Collection;
// 4, 1
import com.fulcrummicro.util.misc.Utility;
// 5, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.*;

public class VerilogRegMapImpl
  extends com.fulcrummicro.util.jamon.timestampImpl
  implements com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.VerilogRegMap.Intf

{
  private final Collection<RegisterCrossbarPort> crossbarPorts;
  private final Collection<RegisterBase> bases;
  private final Collection<Register> regs;
  private final String chip;
  protected static com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.VerilogRegMap.ImplData __jamon_setOptionalArguments(com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.VerilogRegMap.ImplData p_implData)
  {
    com.fulcrummicro.util.jamon.timestampImpl.__jamon_setOptionalArguments(p_implData);
    return p_implData;
  }
  public VerilogRegMapImpl(org.jamon.TemplateManager p_templateManager, com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.VerilogRegMap.ImplData p_implData)
  {
    super(p_templateManager, __jamon_setOptionalArguments(p_implData));
    crossbarPorts = p_implData.getCrossbarPorts();
    bases = p_implData.getBases();
    regs = p_implData.getRegs();
    chip = p_implData.getChip();
  }
  
  @Override protected void child_render_1(final java.io.Writer jamonWriter)
    throws java.io.IOException
  {
    // 12, 9
    jamonWriter.write("// INTEL TOP SECRET\n// Copyright ");
    // 14, 14
    {
      // 14, 14
      __jamon_innerUnit__copyright_year(jamonWriter, __jamon__get_Method_Opt_creationYear_default());
    }
    // 14, 35
    jamonWriter.write(" Intel Corporation. All Rights Reserved.\n//\n// THIS FILE IS AUTOMATICALLY GENERATED - DO NOT MODIFY.\n// Last Updated ");
    // 17, 17
    {
      // 17, 17
      __jamon_innerUnit__timestamp(jamonWriter);
    }
    // 17, 32
    jamonWriter.write("\n//\n// Functions defined:\n//\n");
    // 21, 1
    for (RegisterCrossbarPort xbPort : crossbarPorts )
    {
      // 22, 1
      if (xbPort.hasBusStops() )
      {
        // 22, 29
        jamonWriter.write("//   ");
        // 23, 6
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getBusStopCspAttributeName()), jamonWriter);
        // 23, 47
        jamonWriter.write("\n");
      }
    }
    // 25, 8
    jamonWriter.write("\npackage register_map_pkg;\n  import register_constants_pkg::*;\n  import mgmt_constants_pkg::*;\n  \n  typedef struct packed {\n    logic[24-1:0] addr;        // chip addr\n    logic[8-1:0]  bus_stop_nr; // target bus stop\n    logic[4-1:0]  num_words;   // number of atomic words in this register\n                               // otherwise one for non-atomic reg\n    logic[4-1:0]  word_nr;     // word offset for current mgmt cycle for atomic reg\n                               // otherwise zero for non-atomic reg\n  } decoded_register_t;\n\n\n");
    // 41, 1
    for (RegisterCrossbarPort xbPort : crossbarPorts )
    {
      // 42, 1
      if (xbPort.hasBusStops() )
      {
        // 47, 8
        jamonWriter.write("\n  function automatic void ");
        // 49, 27
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(Utility.camelCaseToUnderscore(xbPort.getBusStopCspRawName()).toLowerCase()), jamonWriter);
        // 49, 107
        jamonWriter.write("_reg_map (\n    input logic [24-1:0]  chip_addr,\n    output decoded_register_t dec_reg\n  );\n    logic[3:0] word;\n    word = chip_addr[3:0];\n\n    dec_reg.num_words = 4'd1; // default for registers w/ atomic width 1\n    dec_reg.word_nr   = '0; // default for registers w/ atomic width 1\n    dec_reg.bus_stop_nr = '0; // need default for invalid range\n    dec_reg.addr = chip_addr;\n    //assumes all registers aligned to power of 2\n    //assumes max atomic width < 4\n      \n    case(1'b1)\n");
        // 64, 14
        for (RegisterBusStop busStop : xbPort.getBusStops() )
        {
          // 65, 16
          for (RegisterBase base : busStop.getRegisterBases() )
          {
            // 65, 71
            jamonWriter.write("      (chip_addr & ");
            // 66, 20
            org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("24'h%06x", ~(base.getSize() - 1) & 0xffffff)), jamonWriter);
            // 66, 85
            jamonWriter.write(") == ");
            // 66, 90
            org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("24'h%06x", base.getAbsoluteAddress())), jamonWriter);
            // 66, 148
            jamonWriter.write(": begin\n        // ");
            // 67, 12
            org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(base.getFullName()), jamonWriter);
            // 67, 36
            jamonWriter.write("\n");
            // 68, 18
            if (busStop.getStride() > 0 )
            {
              // 68, 49
              jamonWriter.write("        logic[24-1:0] bus_stop_offset;\n        bus_stop_offset = (chip_addr - ");
              // 70, 40
              org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(base.getFullName()), jamonWriter);
              // 70, 64
              jamonWriter.write(") / ");
              // 70, 68
              org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("24'h%x",busStop.getStride())), jamonWriter);
              // 70, 117
              jamonWriter.write(";\n        dec_reg.bus_stop_nr = ");
              // 71, 31
              org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(busStop.getName()), jamonWriter);
              // 71, 54
              jamonWriter.write(" + bus_stop_offset[7:0];\n");
            }
            // 72, 18
            else
            {
              // 72, 25
              jamonWriter.write("        dec_reg.bus_stop_nr = ");
              // 73, 31
              org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(busStop.getName()), jamonWriter);
              // 73, 54
              jamonWriter.write(";\n");
            }
            // 74, 24
            jamonWriter.write("        dec_reg.num_words   = 4'd");
            // 75, 34
            org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(base.getAtomicWidth()), jamonWriter);
            // 75, 61
            jamonWriter.write(";\n        ");
            // 76, 9
            {
              // 76, 9
              __jamon_innerUnit__print_atomic_word_nr(jamonWriter, base.getAtomicWidth() );
            }
            // 76, 70
            jamonWriter.write("\n      \n");
            // 78, 1
            boolean found=false; 
            // 79, 18
            for (Register reg : base.getRegisters() )
            {
              // 80, 1
              if ((reg.getAlias() == null) && (reg.getAtomicWidth()!=base.getAtomicWidth()))
              {
                // 81, 1
                if (!found )
                {
                  // 81, 15
                  jamonWriter.write("        case(1'b1)\n");
                }
                // 83, 7
                found=true; 
                // 84, 51
                jamonWriter.write("          (( chip_addr & ");
                // 85, 26
                org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("24'h%h", reg.getAddressMatchMask() & 0xffffff)), jamonWriter);
                // 85, 93
                jamonWriter.write(" ) == ");
                // 85, 99
                org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("24'h%h",reg.getUnitBaseAddress() + reg.getAddressOffset())), jamonWriter);
                // 85, 178
                jamonWriter.write("): begin\n");
                // 86, 1
                int atomicWidth = reg.getAtomicWidth();
//MGMT_IN address decoding requirements:
//mgmt_in needs a word number in the atomic cache, ideally we take
//address % atomicWidth to get word number, however we want to use bit select
//for optimization
//if bit select is used, then % operator is the same as bit select when
//atomicWidth is a power of 2
//when atomic width is not a power of 2, then the bit select does not work if
//the register length is greater than the atomic width because the upper words
//will not be written
if (!Util.isPowerOf2(atomicWidth)) {
	if (reg.getEntryWidth() > atomicWidth) {
		System.out.printf("ERROR %s reg width = %d > atomic width = %d, upper words inaccessible\n",
			reg.getName(), reg.getEntryWidth(), atomicWidth);
	}
}
if(reg.getAtomicWidth()<base.getAtomicWidth()) {
    System.out.printf("WARNING %s base atomic width = %d > atomic width = %d\n",
                      reg.getName(), base.getAtomicWidth(), atomicWidth);
}

                // 107, 3
                jamonWriter.write("            dec_reg.num_words   = ");
                // 108, 35
                org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                // 108, 54
                jamonWriter.write("_ATOMIC_WIDTH; // ");
                // 108, 72
                org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(atomicWidth), jamonWriter);
                // 108, 89
                jamonWriter.write("\n            ");
                // 109, 13
                {
                  // 109, 13
                  __jamon_innerUnit__print_atomic_word_nr(jamonWriter, atomicWidth );
                }
                // 109, 64
                jamonWriter.write("\n            ");
                // 110, 13
                {
                  // 110, 13
                  __jamon_innerUnit__print_atomic_word_addr(jamonWriter, atomicWidth );
                }
                // 110, 66
                jamonWriter.write("\n          end\n");
              }
            }
            // 113, 1
            if (found )
            {
              // 113, 14
              jamonWriter.write("          default: begin\n            ");
              // 115, 13
              {
                // 115, 13
                __jamon_innerUnit__print_atomic_word_addr(jamonWriter, base.getAtomicWidth() );
              }
              // 115, 76
              jamonWriter.write("\n          end\n        endcase\n");
            }
            // 118, 1
            else if (base.getAtomicWidth() > 1 )
            {
              // 118, 38
              jamonWriter.write("        ");
              // 119, 9
              {
                // 119, 9
                __jamon_innerUnit__print_atomic_word_addr(jamonWriter, base.getAtomicWidth() );
              }
              // 119, 72
              jamonWriter.write("\n");
            }
            // 120, 7
            jamonWriter.write("      end\n");
          }
        }
        // 123, 42
        jamonWriter.write("    endcase\n  endfunction\n");
      }
    }
    // 131, 1
    jamonWriter.write("endpackage\n\n");
  }
  
  
  // 146, 1
  private void __jamon_innerUnit__print_atomic_word_addr(final java.io.Writer jamonWriter, final int atomicWidth)
    throws java.io.IOException
  {
    // 148, 1
    if (atomicWidth > 1 )
    {
      // 148, 24
      jamonWriter.write("dec_reg.addr[");
      // 149, 14
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(Util.log2(atomicWidth)-1), jamonWriter);
      // 149, 44
      jamonWriter.write(":0]   = '0;");
    }
    // 150, 1
    else
    {
      // 150, 8
      jamonWriter.write("dec_reg.word_nr     = '0;");
    }
  }
  
  
  // 135, 1
  private void __jamon_innerUnit__print_atomic_word_nr(final java.io.Writer jamonWriter, final int atomicWidth)
    throws java.io.IOException
  {
    // 137, 1
    if (atomicWidth > 4) {
	System.out.printf("ERROR register map synth version does not support atomic width=%d > 4\n",atomicWidth);
}
int atomicMask = (1 << Util.log2(atomicWidth)) - 1;

    // 142, 3
    jamonWriter.write("dec_reg.word_nr     = word & ");
    // 143, 30
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("4'h%h",atomicMask)), jamonWriter);
    // 143, 69
    jamonWriter.write(";");
  }
  
  
}
