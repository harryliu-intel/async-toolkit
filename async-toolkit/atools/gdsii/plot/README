GDS plotting package
gds2plot & plot
Authors: Andrew Lines & Aubrey Grey
Copyright: Intel, 2015
Support: andrew.lines@intel.com

----------------------------- BACKGROUND ---------------------------------------

Gds2plot is a C program that renders high quality plots of a GDS file.
A required configuration file, usually called gds2plot.conf, defines
the layer mapping from GDS to RGBA values.  The syntax is:

#     R     G     B     A       (boolean expression of gds2 layernum:datatype)
paint 0-255 0-255 0-255 0.0-1.0 layer # comment
paint ...

The GDS layer can be defined as layernum or layernum:datatype and
combined into boolean expressions with (, ), ||, &&, !, ==, != boolean
operators.  Typical uses of this feature are to imply n-diff from
diffusion and n-implant, or to merge B and C metal colorings.

The layers are painted in order starting with a white background.
Alpha is the opacity of the layer, where 1.0 means completely opaque
(replaces the previous color) and 0.0 is completely transparent.
Experience has shown that the lowest layers should be opaque, and
upper layers get gradually more transparent.  The colors of the lower
layers came from Magic's default palette circa 1994.

Gds2plot loads the GDS database into memory, then renders at
manufacturing grid resolution (just like making masks).  To reduce
memory consumption, it only renders one tile (typically 20000 pixels
square) at a time.  After the tile is rendered, it is down-scaled to
the output resolution.  Once all the tiles in horizontal stripe are
rendered, the data is written to a ppm file.

For large GDS files, it saves a lot of memory and runtime to stream
out a GDS file with only relevant layernum:datatype and no labels.
The gds2plot_layer_map.rules is an example compatible with Virtuoso.

For best results, it is recommended to distinguish fill shapes and
power wires with different GDS datatypes and exclude these datatypes
from the conf file.  Otherwise the plots look almost solid color.

------------------------- WRAPPER ----------------------------------------------

Plot is a perl script wrapper that is the normal way to use gds2plot.
It breaks the task into parallel jobs using netbatch, then stitches
the stripes back together and converts the final image to a standard
format like png.  Typical usage is "plot --jobs=16 myfile" which will
plot myfile.gds to myfile.png using default options.  If you run in
another directory you should create sym-links or specify the conf-file
and exclude-file arguments and include the gds2plot directory in your
search path.  If you want to plot a subcell, use the --cell option to
specify its GDS name.  By default gds2plot will auto-detect the
top-level cell (a cell which is not instantiated by any other cell).

An --excude-file=exclude.in contains a set of regular expressions
(perl style) of cell names to skip when plotting.  This is typically
used to skip fill cells so that "empty" space actually looks empty.  A
sample exlcude.in is provided to skip D04 fill cells.

If you specify jobs>0 plot will use netbatch to launch multiple
stripes in parallel.  Netbatch will use the environment variables
NBPOOL, NBQSLOT, NBCLASS.  The output of each job is saved to
basename.out.# where # is the job number.  It creates a basename.do.#
file which prevents a subsequent call of plot from launching that job
again.  If a job crashes, delete that basename.do.# file and run plot
again, and it will just rerun jobs for the missing do files.  After
the jobs have finished (or partially finished) you can run plot again
with the same arguments to concatenate the basename.ppm.# files into a
single file and convert it to the desired output format (png).  It is
wise to log into one of the netbatch servers to check the memory
usage, and in subsequent runs specify the --mem option appropriately.

-------------------------------- USAGE -----------------------------------------

Run "$GDS2PLOT_DIR/plot" with no arguments to get a usage banner with
simple comments.

(1) Create a scratch_dir directory.  Sym-link or copy the
    gds2plot.conf and exclude.in, as well as your_file.gds file:

    cd $scratch_dir
    ln -s $GDS2PLOT_DIR/exclude.in    .
    ln -s $GDS2PLOT_DIR/gds2plot.conf .
    ln -s your_file.gds               .

(2) Set netbatch environment variables (required if you specify
    --jobs=# argument).  Example:

    setenv NBPOOL pdx_normal
    setenv NBQSLOT /ilabs/wcr
    setenv NBCLASS SLES10_EM64T_16G

(3) Run the plot script.  Example:

    $GDS2PLOT_DIR/plot --jobs=16 --cell=your_top_cell your_file

(4) If you're netbatching the run, you will see the jobs get launched
    and then queued:

    # Lauching your_file, job 0
    ...
    # Lauching your_file, job 15
    Your job has been queued (JobID 2365671187, Class EXPR, Queue Slot /ilabs/wcr)
    ...
    Your job has been queued (JobID 2365671220, Class EXPR, Queue Slot /ilabs/wcr)

(5) Monitor progress by checking the your_file.out.# files.
    Individual runs are completed when you see the "Finished" message,
    such as:

    ...
    Top cell is your_top_cell
    Computing bounding boxes at 33s
    xsize=11929 ysize=13137 Nsubpixels=191
    x0=-191 y0=-191 x1=2278248 y1=2508976 tile=20055
    Rendering rows 403201 <= y < 423256 at 111s
    ...
    Finished at 7713s

(6) If the run was netbatched, all your_file.ppm.# files need to be
    concatenated.  Re-run the plot command with the same arguments as
    step (3) to complete this.  You can also specify --format to
    choose between common image formats to convert to (i.e. jpg, png).

    $GDS2PLOT_DIR/plot --jobs=16 --cell=your_top_cell --format=png your_file

    Concatenating your_file.ppm

(7) View the result with "gimp your_file.png".  Gimp is useful for
    scaling the image to make smaller plots (for e-mail or PowerPoint)
    and for converting image formats.
