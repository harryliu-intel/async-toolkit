# vim:et:sw=4:syntax=make:ts=4:tw=79:
###############################################################################
# File:             Makefile.validation
# Creation Date:    October 7, 2011
# Description:      Makefile for the validation platform. This makefile is
#                   responsible for setting:
#                       PLAT_OBJ      - the object files to be compiled for the
#                                       platform code
#                       PLAT_TARGETS  - the targets to be installed for the
#                                       platform
#
# INTEL CONFIDENTIAL
# Copyright 2011 - 2013 Intel Corporation
# All Rights Reserved.
###############################################################################

###############################################################################
# Includes
###############################################################################

# Defined before the microcode Makefile include to provide the command
# used to checkout the auto-generated files (if neccessary).
MICROCODE_CHECKOUT_FILES = xargs $(P4) edit

# This is because in regular manual build mode, the ucode file is found in
# ../build, but in test mode, it is found in the model directory without a
# ../build tree available.
-include Makefile.ucode
-include ../build/Makefile.ucode

###############################################################################
# Command-line Overridable Variables
###############################################################################

# The hardware platform on which the validation platform is based.
HARDWARE_PLATFORM ?= barcelona

###############################################################################
# Sources
###############################################################################

# Specify whether switch/router microcode is to be dynamically-loaded or
# internally-built into main library. 1 == dynamically-load, 0 = internal.
UCODE_SWITCH_DL = 1

# This address is an unused fixed address at which to locate the FocalPoint
# library.
SO_BASE_ADDRESS = 0x02000000

# This address is an unused fixed address at which to locate the
# Dynamically-Loaded Microcode library/libraries.
DLIB_BASE_ADDRESS = 0x02600000

# The set of chip families supported by the validation platform.
SUPPORTED_CHIP_FAMILIES = FM6000

# Prevent the precompiled headers from being built to work around a build error
# caused by GCC crashing due to an internal compiler error (ICE).
override GCH_OBJ :=

# Include all source code found in the platform and hardware platform
# directories.
PLAT_SRC = platforms/$(PLATFORM)/fm6000/$(HARDWARE_PLATFORM)/fm6000_platform.c
PLAT_SRC += $(wildcard platforms/$(HARDWARE_PLATFORM)/*.c)
PLAT_SRC += $(filter-out %/fm6000_platform.c,$(wildcard platforms/$(HARDWARE_PLATFORM)/fm6000/*.c))

# Include all needed common code.
PLAT_SRC += platforms/common/fm_file_attr_loader.c
PLAT_SRC += $(wildcard platforms/common/buffers/std-alloc/*.c)
PLAT_SRC += $(wildcard platforms/common/event/*.c)
PLAT_SRC += $(wildcard platforms/common/lib/dll/*.c)
PLAT_SRC += $(wildcard platforms/common/lib/ucode/*.c)
PLAT_SRC += $(wildcard platforms/common/packet/generic-netlink/*.c)
PLAT_SRC += $(wildcard platforms/common/packet/generic-packet/*.c)
PLAT_SRC += $(wildcard platforms/common/packet/generic-packet/fm6000/*.c)
PLAT_SRC += $(wildcard platforms/common/phy/*.c)
PLAT_SRC += $(wildcard platforms/common/stubs/*.c)

# List of platform object files
PLAT_OBJ = $(patsubst %.c,%.o,$(PLAT_SRC))

# List of all Dynamic-Load-Libraries that are created for this platform
DLIB_SO = $(DLIB1_SO)
DLIBS   = DLIB1

# First Dynamic-Load-Library: Switch/Router microcode and model code
DLIB1_SRC = api/fm6000/fm6000_api_uc_attr.c
DLIB1_SRC += api/fm6000/fm6000_api_uc_init.c
DLIB1_SRC += api/fm6000/fm6000_api_uc_port_attr.c
DLIB1_SRC += api/fm6000/fm6000_api_uc_vlan_attr.c
DLIB1_SRC += api/fm6000/fm6000_api_uc_stats.c

ifeq ($(UCODE_SWITCH_DL),1)
    DLIB1_NAME            = "FocalPoint AWM Switch/Router"
    DLIB1_A               = ../build/fm_awm_switch.a
    DLIB1_SO_NAME         = libFocalPoint_AWM_switch.$(SO_EXTENSION)
    DLIB1_SO              = ../build/$(DLIB1_SO_NAME)
    DLIB1_SO_BASE_ADDRESS = ( $(DLIB_BASE_ADDRESS) + 0 )
    DLIB1_OBJ             = $(patsubst %.c,%.o,$(DLIB1_SRC))
    DLIB1_LNK             = ../build/libFocalpoint_AWM_switch.lds
else
    PLAT_SRC              += $(DLIB1_SRC)
endif

# Include the kernel code.
PLAT_KMOD_SRC = $(wildcard platforms/$(HARDWARE_PLATFORM)/kernel/focalpoint/*.c)
PLAT_KMOD_SRC += $(wildcard platforms/common/driver/linux/kernel/2.6.35/fm6000/*.c)
PLAT_KMOD     = platforms/$(HARDWARE_PLATFORM)/kernel/focalpoint/focalpoint.ko

# The exported list of targets.
PLAT_TARGETS = $(PLAT_KMOD) ../build/microcode.raw

###############################################################################
# Global Variables
###############################################################################

# Compiler settings conditionalized because we don't use a cross compiler for
# emulation
CC  = $(CROSS_COMPILE)gcc
CXX = $(CROSS_COMPILE)g++
AR  = $(CROSS_COMPILE)ar
LD  = $(CROSS_COMPILE)ld

MKDIR   = mkdir
MODPOST = $(KERN_BASE_DIRECTORY)/scripts/mod/modpost

API_BASE_DIRECTORY  = $(abspath ../../fulcrum)
KERN_BASE_DIRECTORY = $(abspath ../../vendor/kernel.org)

PERL_CPPFLAGS   =
PERL_CFLAGS     = $(CWARNING_FLAGS) -D_GNU_SOURCE -std=c99 -fPIC \
                  -Wno-format-zero-length -Wno-unused-parameter
PERL_EXTRA_LIBS =

ifeq ($(HARDWARE_PLATFORM),barcelona)
    PLAT_SRC += $(wildcard platforms/common/fibm/*.c)
    PLAT_SRC += $(wildcard platforms/common/fibm/fm6000/*.c)
    # The Barcelona platform has EBI support and thus supports LCI.
    PLAT_SRC += $(wildcard platforms/common/packet/generic-lci/fm6000/*.c)

    export ARCH = ppc

    # Command-line overrideable variables.
    CROSS_COMPILE ?= $(FMTOOLBASE)/usr/bin/ppc_85xx-
    ELDKBASE      ?= /p/utils/srd/software/cross-compilers/eldk/rootfs-usr
    FMTOOLBASE    ?= /p/utils/srd/software/cross-compilers/eldk/toolchain

    CPPFLAGS += -D_FM_ARCH_ppc -DHARDWARE_PLATFORM=0 -I../include/std/mpc8245

    # All Perl related flags are finalized with help of the ExtUtils::Embed
    # module on the host machine where Perl will be run.
    PERL_CPPFLAGS         += -I$(ELDKBASE)/local/lib/perl5/5.8.8/ppc-linux/CORE
    PERL_CFLAGS           += -fno-strict-aliasing -pipe \
                             -Wdeclaration-after-statement \
                             -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    PERL_EXTRA_LIBS       += -L$(ELDKBASE)/lib/gcc/ppc-linux/4.0.0 -lgcc
    PERL_WRAPPER_CPPFLAGS += -DHARDWARE_PLATFORM=0 -I../include/std/mpc8245

endif   # end ifeq ($(HARDWARE_PLATFORM),barcelona)

ifeq ($(HARDWARE_PLATFORM),seacliff)
    PLAT_SRC     += $(wildcard platforms/common/instrument/*.c)
    SC_MGR_SRC   = platforms/$(HARDWARE_PLATFORM)/utils/sc-mgr.c
    SC_MGR_SRC   += platforms/$(HARDWARE_PLATFORM)/platform_com.c
    SC_MGR_SRC   += common/fm_c11_annex_k.c
    SC_MGR       = platforms/$(HARDWARE_PLATFORM)/utils/sc-mgr
    PLAT_TARGETS += $(SC_MGR)

    BUILD_HOST_IS_64BIT = $(shell uname -a | grep x86_64)
    ifeq ($(BUILD_HOST_IS_64BIT),)
        $(error Cannot compile 64-bit platform on 32-bit host)
    endif

    export ARCH = x86_64

    MODPOST = $(API_BASE_DIRECTORY)/build/$(KERN_BUILD_PLAT)/scripts/mod/modpost

    CROSS_COMPILE ?=
    ELDKBASE      ?= /p/utils/srd/software/distro/fedora14/os/x86_64

    KERN_BUILD_PLAT   = $(HARDWARE_PLATFORM)_64
    KERN_EXTRAARGS    = AS=gas LD=gld AR=gar NM=gnm STRIP=gstrip \
                        OBJCOPY=gobjcopy OBJDUMP=gobjdump
    KERN_EXTRAVERSION = -x86_64-Seacliff

    CPPFLAGS += -D_FM_ARCH_x86_64 -DHARDWARE_PLATFORM=1 -I../include/std/intel

    # All Perl related flags are finalized with help of the ExtUtils::Embed
    # module on the host machine where Perl will be run.
    PERL_CPPFLAGS         += -I$(ELDKBASE)/usr/lib64/perl5/CORE
    PERL_CFLAGS           += -fno-strict-aliasing -pipe \
                             -Wdeclaration-after-statement \
                             -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    PERL_EXTRA_LIBS       += -L$(ELDKBASE)/usr/lib/gcc/x86_64-redhat-linux/4.5.1 \
                             -lgcc
    PERL_WRAPPER_CPPFLAGS += -DHARDWARE_PLATFORM=1 -I../include/std/intel

    API_BASE_DIRECTORY = $(abspath ..)

endif   # end ifeq ($(HARDWARE_PLATFORM),seacliff)

# The software generated interface cannot be compiled with pedantic warnings
# enabled.
PERL_CFLAGS := $(filter-out -pedantic% -Werror,$(PERL_CFLAGS))

###############################################################################
# Targets
###############################################################################

fm6000_platform : platforms/$(HARDWARE_PLATFORM)/fm6000/fm6000_platform.c \
                  platforms/$(PLATFORM)/fm6000/fm6000_platform.i \
                  platforms/$(PLATFORM)/fm6000/fm6000_platform.awk \
                  platforms/$(PLATFORM)/fm6000/$(HARDWARE_PLATFORM)
	cd $(CURDIR) && \
		echo platforms/$(PLATFORM)/fm6000/$(HARDWARE_PLATFORM)/fm6000_platform.c \
		| $(MICROCODE_CHECKOUT_FILES)
	$(GAWK) -f platforms/$(PLATFORM)/fm6000/fm6000_platform.awk \
			-W re-interval \
			-v INC=platforms/$(PLATFORM)/fm6000/fm6000_platform.i \
			platforms/$(HARDWARE_PLATFORM)/fm6000/fm6000_platform.c \
		| $(GSED) -r -e "s/[[:blank:]]+$$//g" > \
			platforms/$(PLATFORM)/fm6000/$(HARDWARE_PLATFORM)/fm6000_platform.c

platforms/$(PLATFORM)/fm6000/$(HARDWARE_PLATFORM) platforms/$(PLATFORM)/kernel/focalpoint :
	[ -d $(@) ] || $(MKDIR) -p $@

ifeq ($(HARDWARE_PLATFORM),barcelona)

$(MODPOST) :
	(cd $(KERN_BASE_DIRECTORY) && ./build modules_prepare)

$(PLAT_KMOD) : $(PLAT_KMOD_SRC) $(MODPOST)
	(cd $(KERN_BASE_DIRECTORY) && \
		./build SUBDIRS=$(API_BASE_DIRECTORY)/src/platforms/$(HARDWARE_PLATFORM)/kernel/focalpoint/ \
		        SDK_ROOT=$(API_BASE_DIRECTORY) \
		        PLATFORM=$(HARDWARE_PLATFORM) \
		        modules)

endif   # end ifeq ($(HARDWARE_PLATFORM),barcelona)

ifeq ($(HARDWARE_PLATFORM),seacliff)

$(MODPOST) :
	(cd $(KERN_BASE_DIRECTORY) && \
		./build mrproper && \
		$(MAKE) O=$(API_BASE_DIRECTORY)/build/$(KERN_BUILD_PLAT) \
		        EXTRAVERSION=$(KERN_EXTRAVERSION) \
		        modules_prepare)

$(PLAT_KMOD) : $(PLAT_KMOD_SRC) $(MODPOST)
	(cd $(KERN_BASE_DIRECTORY) && \
		$(MAKE) $(KERN_EXTRAARGS) \
		        SUBDIRS=$(API_BASE_DIRECTORY)/src/platforms/$(HARDWARE_PLATFORM)/kernel/focalpoint/ \
		        SDK_ROOT=$(API_BASE_DIRECTORY) \
		        PLATFORM=$(HARDWARE_PLATFORM) \
		        O=$(API_BASE_DIRECTORY)/build/$(KERN_BUILD_PLAT) \
		        EXTRAVERSION=$(KERN_EXTRAVERSION) \
		        modules)

$(SC_MGR) : $(SC_MGR_SRC)
	$(CC) $(CFLAGS) -g -o $@  -I../include $^ $(LFLAGS)

endif   # end ifeq ($(HARDWARE_PLATFORM),seacliff)

.PHONY: fm6000_platform
