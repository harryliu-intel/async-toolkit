#!/usr/intel/bin/perl

## This script siphons data printed by tsim for that generated by
## Reg4.java and prints that data in a more useful format.  It doesn't
## account for the different ending times of Reg4 blocks based on the
## last data each processes.


#Functions for taking fields of output lines
sub timestamp {
    my @fields = split (/ +/,@_[0]);
    chop($fields[0]);    # Remove the colon
    return $fields[0];
}
sub instr {
    my @fields = split (/ +/,@_[0]);
    return $fields[2];
}    
sub reg {
    my @fields = split (/ +/,@_[0]);
    my @reg = split("reg=",(split "\t", $fields[3])[0]);
    return $reg[1];
}
sub stalltime {
    my @fields = split (/ +/,@_[0]);
    my @reg = split("time=",$fields[4]);
    chomp $reg[1];
    return $reg[1];
}
sub plainreads {
    my @fields = split (/ +/,@_[0]);
    my @reg = split("\t",$fields[7]);
    return $reg[0];
}
sub dupreads {
    my @fields = split (/ +/,@_[0]);
    my @reg = split("\t",$fields[8]);
    return $reg[0];
}
sub fullnesses {
    my @fields = split (/ +/,@_[0]);
    return join ("\t", (split ("\t",@fields[3]))[1..9]);
}

if ($#ARGV != 0) {
    die "usage:\tgrabRegisterdata.pl [filename of tsim output]\n";
}

$tsimOutputFile = $ARGV[0];

### Read in the output of tsim
open TSIM_OUTPUT, "< $tsimOutputFile" or die "can't open $tsimOutputFile";
# Only check register lines
while (<TSIM_OUTPUT>) {
    if (/REG/) {
        @lines[$lineNum++] = $_;
    }
}

### Get read proportions
foreach $line (@lines) {
    if (instr($line) eq "reads") {
        $plain += plainreads($line);
        $dup += dupreads($line);
    }
}
print "$plain normal reads and $dup duplicating reads\n";

### Get fullness histograms for each register
@fullnesses;
foreach $line (@lines) {
    if (instr($line) eq "fullness") {
        $fullnesses[reg($line)] = fullnesses($line);
    }
}

print "amount of time each register spends containing n tokens\n";
print "\t0\t1\t2\t3\t4\t5\t6\t7\t8\n";
for ($i=0; $i<16; $i++) {
    print "reg: $i\t$fullnesses[$i]";
}






### Get all stalls
foreach $line (@lines) {
    if (instr($line) eq "readstall") {
        push @{$readstalls[reg($line)]}, stalltime($line);
    }
}
print "Stall times while trying to read in data:\n";
for ($i=0; $i<16; $i++) {
    print "reg: $i\t";
    foreach $time (sort {$a <=> $b} (@{$readstalls[$i]})) {
        print " $time";
    }
    print "\n";
}
foreach $line (@lines) {
    if (instr($line) eq "writestall") {
        push @{$writestalls[reg($line)]}, stalltime($line);
    }
}
print "Stall times while trying to write out data:\n";
for ($i=0; $i<16; $i++) {
    print "reg: $i\t";
    foreach $time (sort {$a <=> $b} (@{$writestalls[$i]})) {
        print " $time";
    }
    print "\n";
}

