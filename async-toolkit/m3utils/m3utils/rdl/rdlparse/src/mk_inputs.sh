#!/bin/sh -x
rm -rf ../AMD64_LINUX
mkdir ../AMD64_LINUX

rm -f rdl.y.*
rm -f rdl.l
rm -f rdl.t

make_interface()
{
    fn=$1
    nm=$2
    ifn=../AMD64_LINUX/${nm}.i3
    cat > ${ifn} <<EOF
INTERFACE ${nm};

(* automatically generated by $0 *)

TYPE T = {
EOF
    cat ${fn} | awk 'BEGIN {comma=""} {printf("%s %s ", comma, $1); comma=","}' >> ${ifn}
    
    cat >> ${ifn} <<EOF
};

CONST Names = ARRAY T OF TEXT {
EOF

        cat ${fn} | awk 'BEGIN {comma=""} {printf("%s \"%s\" ", comma, $1); comma=","}' >> ${ifn}


    cat >> ${ifn} <<EOF  
};

CONST Brand = "${nm}";

END ${nm}.
EOF
}

camelize()
{
    in=$1;
    echo $in | sed 's/\.dat$//' | sed  -e 's/_\(.\)/\U\1/g' -e 's/^\(.\)/\U\1/'
}

cat *.dat | sort | grep -v '^$' | uniq | awk '{printf("T_%-15s \"%s\"\n",toupper($1),$1)}' > rdl.l.2

cat rdl.l.[0-9] > rdl.l

cat *.dat | sort | grep -v '^$' | uniq | awk '{printf("%%const T_%s\n", toupper($1))}' > rdl.t.1

cat rdl.t.[0-9] > rdl.t

for file in *.dat; do
  base=`basename ${file} .dat`
  cat ${file} | awk '{printf("  %-23s T_%-15s\n", $1, toupper($1))}' > rdl.y.${base}
  make_interface ${file} `camelize ${file}`
done




