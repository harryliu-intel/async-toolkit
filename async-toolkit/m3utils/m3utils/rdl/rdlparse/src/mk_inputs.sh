#!/bin/sh -x

DERIV=../AMD64_LINUX

rm -rf ${DERIV}
mkdir ${DERIV}

#rm -f rdl.y.*
rm -f rdlParseExt.e
rm -f rdl.l
rm -f rdl.t

make_interface()
{
    fn=$1
    nm=$2
    ifn=${DERIV}/${nm}.i3
    cat > ${ifn} <<EOF
INTERFACE ${nm};

(* automatically generated by $0 *)

TYPE T = {
EOF
    cat ${fn} | awk 'BEGIN {comma=""} {printf("%s %s ", comma, $1); comma=","}' >> ${ifn}
    
    cat >> ${ifn} <<EOF
};

CONST Names = ARRAY T OF TEXT {
EOF

        cat ${fn} | awk 'BEGIN {comma=""} {printf("%s \"%s\" ", comma, $1); comma=","}' >> ${ifn}


    cat >> ${ifn} <<EOF  
};

CONST Brand = "${nm}";

END ${nm}.
EOF
}

camelize()
{
    in=$1;
    echo $in | sed 's/\.dat$//' | sed  -e 's/_\(.\)/\U\1/g' -e 's/^\(.\)/Rdl\U\1/'
}

mk_e_fragment()
{
    fn=$1
    base=$2
    nm=$3
    echo mk_e_fragment $fn $base $nm
    efn=${DERIV}/${base}.e.fragment
    cat  > ${efn} <<EOF

IMPORT ${nm};

${base}: { val: ${nm}.T }
EOF
    cat ${fn} | awk "{printf(\"  %-25s { \$\$ := ${nm}.T.%s }\n\", \$1, \$1)}" >> ${efn}
}

cat *.dat | sort | grep -v '^$' | uniq | awk '{printf("T_%-15s \"%s\"\n",toupper($1),$1)}' > rdl.l.2

cat rdl.l.[0-9] > rdl.l

cat *.dat | sort | grep -v '^$' | uniq | awk '{printf("%%const T_%s\n", toupper($1))}' > rdl.t.1

cat rdl.t.[0-9] > rdl.t

for file in *.dat; do
  base=`basename ${file} .dat`
  cat ${file} | awk '{printf("  %-23s T_%-15s\n", $1, toupper($1))}' > ${DERIV}/rdl.y.${base}
  intf=`camelize ${file}`
  make_interface ${file} ${intf}
  mk_e_fragment ${file} ${base} ${intf}
done

cpp -P -I${DERIV} rdlParseExt.ee -o rdlParseExt.e


