// Autogenerated Jamon implementation
// /nfs/sc/proj/ctg/mrl108/rliu68/sw-intel5/cad/java/src/./com/fulcrummicro/hw/verification/chip/mgmt/registers/templates/Tcl.jamon

package com.fulcrummicro.hw.verification.chip.mgmt.registers.templates;

// 8, 1
import java.util.Collection;
// 9, 1
import com.fulcrummicro.hw.verification.lib.constants.ConstantsEnum;
// 10, 1
import com.fulcrummicro.hw.verification.lib.constants.ConstantsEnumValue;
// 11, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.Register;
// 12, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.RegisterBase;
// 13, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.RegisterField;

public class TclImpl
  extends com.fulcrummicro.util.jamon.timestampImpl
  implements com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Tcl.Intf

{
  private final Collection<RegisterBase> bases;
  private final Collection<Register> regs;
  private final String pakkage;
  private final String prefix;
  private final int addrBits;
  // 201, 1
  
static final int ndims(Register r) {
    return r.getNumDimensions() == 1 && r.getNumEntries() == 1 ?
           0 :
           r.getNumDimensions();
}
static final StringBuilder __indent = new StringBuilder();
static final int __DECL_DEFAULT_WIDTH = 70;
static final int __DECL_BASE_WIDTH = 60;
static final int __TCL_INDENT = 4;

  protected static com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Tcl.ImplData __jamon_setOptionalArguments(com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Tcl.ImplData p_implData)
  {
    if(! p_implData.getAddrBits__IsNotDefault())
    {
      p_implData.setAddrBits(24);
    }
    com.fulcrummicro.util.jamon.timestampImpl.__jamon_setOptionalArguments(p_implData);
    return p_implData;
  }
  public TclImpl(org.jamon.TemplateManager p_templateManager, com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.Tcl.ImplData p_implData)
  {
    super(p_templateManager, __jamon_setOptionalArguments(p_implData));
    bases = p_implData.getBases();
    regs = p_implData.getRegs();
    pakkage = p_implData.getPakkage();
    prefix = p_implData.getPrefix();
    addrBits = p_implData.getAddrBits();
  }
  
  @Override protected void child_render_1(final java.io.Writer jamonWriter)
    throws java.io.IOException
  {
    // 212, 1
    jamonWriter.write("# INTEL TOP SECRET\n# Copyright ");
    // 213, 13
    {
      // 213, 13
      __jamon_innerUnit__copyright_year(jamonWriter, 2014 );
    }
    // 213, 54
    jamonWriter.write(" Intel Corporation\n# All Rights Reserved.\n#\n# THIS FILE IS AUTOMATICALLY GENERATED - DO NOT MODIFY.\n# Last Updated ");
    // 217, 16
    {
      // 217, 16
      __jamon_innerUnit__timestamp(jamonWriter);
    }
    // 217, 32
    jamonWriter.write("\n#\n\npackage provide ");
    // 220, 17
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 220, 30
    jamonWriter.write(" 1.0\npackage require Tcl 8.4\npackage require FM::BigInt\n\nnamespace eval ::");
    // 224, 18
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 224, 31
    jamonWriter.write(" {\n");
    // 225, 1
    {
      // 225, 1
      __jamon_innerUnit____setindent(jamonWriter, __indent, 1 );
    }
    // 225, 39
    jamonWriter.write("    namespace export get_bit\n    namespace export get_field\n    namespace export set_bit\n    namespace export set_field\n");
    // 230, 1
    for (Register r : regs )
    {
      // 231, 1
      {
        // 231, 1
        __jamon_innerUnit____decl(jamonWriter, r.getName(), null, 1, "namespace export", __indent );
      }
      // 231, 84
      jamonWriter.write("\n");
    }
    // 232, 8
    jamonWriter.write("\n    namespace import ::FM::BigInt::*\n\n    ############################################################################\n    # Register Base Variables\n    ############################################################################\n\n");
    // 240, 1
    for (RegisterBase b : bases )
    {
      // 241, 1
      RegisterBase parent = b.getParent();
      // 242, 1
      {
        // 242, 1
        __jamon_innerUnit____decl(jamonWriter, b.getFullName(), null, __DECL_BASE_WIDTH, "variable", __indent );
      }
      // 242, 96
      jamonWriter.write(" ");
      // 243, 1
      {
        // 243, 1
        __jamon_innerUnit____strfaddr(jamonWriter, b.getIncrementalAddress() );
      }
      // 244, 1
      if (parent.getParent() != null )
      {
        // 244, 35
        jamonWriter.write("+ ($");
        // 244, 39
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(prefix.concat(parent.getFullName()).toUpperCase()), jamonWriter);
        // 244, 94
        jamonWriter.write(")");
      }
      // 244, 101
      jamonWriter.write("\n\n");
      // 246, 1
      for (ConstantsEnum e : b.getEnums() )
      {
        // 247, 1
        {
          // 247, 1
          __jamon_innerUnit____enum(jamonWriter, e );
        }
        // 247, 20
        jamonWriter.write("\n");
      }
    }
    // 249, 8
    jamonWriter.write("\n    ############################################################################\n    # Register Variables & Commands\n    ############################################################################\n\n");
    // 255, 1
    for (Register r : regs )
    {
      // 256, 1
      
int nDims = ndims(r);
boolean w = r.getEntryWidth() > 1;

      // 261, 1
      {
        // 261, 1
        __jamon_innerUnit____decl(jamonWriter, r.getName(), "_BITS", __DECL_DEFAULT_WIDTH, "variable", __indent );
      }
      // 261, 87
      jamonWriter.write(" ");
      // 262, 1
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getNumberFieldBits()), jamonWriter);
      // 262, 29
      jamonWriter.write("\n");
      // 264, 1
      {
        // 264, 1
        __jamon_innerUnit____decl(jamonWriter, r.getName(), "_DEFAULT", __DECL_DEFAULT_WIDTH, "variable", __indent );
      }
      // 264, 90
      jamonWriter.write(" ");
      // 265, 1
      {
        // 265, 1
        __jamon_innerUnit____xdisplay(jamonWriter, r.getDefault(0), r.getNumberFieldBits(), true );
      }
      // 265, 81
      jamonWriter.write("\n");
      // 267, 1
      {
        // 267, 1
        __jamon_innerUnit____decl(jamonWriter, r.getName(), "_NDIMS", __DECL_DEFAULT_WIDTH, "variable", __indent );
      }
      // 267, 88
      jamonWriter.write(" ");
      // 268, 1
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(nDims), jamonWriter);
      // 268, 12
      jamonWriter.write("\n");
      // 270, 1
      {
        // 270, 1
        __jamon_innerUnit____decl(jamonWriter, r.getName(), "_WIDTH", __DECL_DEFAULT_WIDTH, "variable", __indent );
      }
      // 270, 88
      jamonWriter.write(" ");
      // 271, 1
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getEntryWidth()), jamonWriter);
      // 271, 24
      jamonWriter.write("\n");
      // 273, 1
      if (nDims == 0 )
      {
        // 274, 1
        {
          // 274, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), w ? " {{word}}" : " {}", __DECL_DEFAULT_WIDTH, "proc", __indent );
        }
        // 274, 99
        jamonWriter.write(" { ");
        // 275, 3
        {
          // 275, 3
          __jamon_innerUnit____decl(jamonWriter, r.getBaseName(), null, 1, "variable", null );
        }
        // 275, 78
        jamonWriter.write("; return -code ok [expr {");
      }
      // 277, 1
      else if (nDims == 1 )
      {
        // 278, 1
        {
          // 278, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), w ? " {{index} {word}}" : " {{index}}", __DECL_DEFAULT_WIDTH, "proc", __indent );
        }
        // 278, 114
        jamonWriter.write(" { ");
        // 279, 3
        {
          // 279, 3
          __jamon_innerUnit____decl(jamonWriter, r.getBaseName(), null, 1, "variable", null );
        }
        // 279, 78
        jamonWriter.write("; return -code ok [expr {(");
        // 281, 2
        {
          // 281, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace() );
        }
        // 281, 44
        jamonWriter.write(") * (($index) - ");
        // 281, 60
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry()), jamonWriter);
        // 281, 82
        jamonWriter.write(") + ");
      }
      // 282, 1
      else if (nDims == 2 )
      {
        // 283, 1
        {
          // 283, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), w ? " {{index1} {index0} {word}}" : " {{index1} {index0}}", __DECL_DEFAULT_WIDTH, "proc", __indent );
        }
        // 283, 134
        jamonWriter.write(" { ");
        // 284, 3
        {
          // 284, 3
          __jamon_innerUnit____decl(jamonWriter, r.getBaseName(), null, 1, "variable", null );
        }
        // 284, 78
        jamonWriter.write("; return -code ok [expr {(");
        // 286, 2
        {
          // 286, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace1() );
        }
        // 286, 45
        jamonWriter.write(") * (($index1) - ");
        // 286, 62
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry1()), jamonWriter);
        // 286, 85
        jamonWriter.write(") + (");
        // 287, 2
        {
          // 287, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace() );
        }
        // 287, 44
        jamonWriter.write(") * (($index0) - ");
        // 287, 61
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry()), jamonWriter);
        // 287, 83
        jamonWriter.write(") + ");
      }
      // 288, 1
      else if (nDims == 3 )
      {
        // 289, 1
        {
          // 289, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), w ? " {{index2} {index1} {index0} {word}}" : " {{index2} {index1} {index0}}", __DECL_DEFAULT_WIDTH, "`define", __indent );
        }
        // 289, 155
        jamonWriter.write(" { ");
        // 290, 3
        {
          // 290, 3
          __jamon_innerUnit____decl(jamonWriter, r.getBaseName(), null, 1, "variable", null );
        }
        // 290, 78
        jamonWriter.write("; return -code ok [expr {(");
        // 292, 2
        {
          // 292, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace2() );
        }
        // 292, 45
        jamonWriter.write(") * (($index2) - ");
        // 292, 62
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry2()), jamonWriter);
        // 292, 85
        jamonWriter.write(") + (");
        // 293, 2
        {
          // 293, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace1() );
        }
        // 293, 45
        jamonWriter.write(") * (($index1) - ");
        // 293, 62
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry1()), jamonWriter);
        // 293, 85
        jamonWriter.write(") + (");
        // 294, 2
        {
          // 294, 2
          __jamon_innerUnit____strfaddr(jamonWriter, r.getEntrySpace() );
        }
        // 294, 44
        jamonWriter.write(") * (($index0) - ");
        // 294, 61
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(r.getBaseEntry()), jamonWriter);
        // 294, 83
        jamonWriter.write(") + ");
      }
      // 295, 1
      else
      {
        // 296, 1
        throw new Error(nDims + "-dimensional registers not supported");
      }
      // 298, 1
      if (w )
      {
        // 298, 10
        jamonWriter.write("($word) + ");
      }
      // 298, 26
      jamonWriter.write("(");
      // 299, 2
      {
        // 299, 2
        __jamon_innerUnit____strfaddr(jamonWriter, r.getAddressOffset() );
      }
      // 299, 47
      jamonWriter.write(") + ($");
      // 300, 3
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(prefix.toUpperCase() + r.getBaseName()), jamonWriter);
      // 300, 47
      jamonWriter.write(")}] }\n\n");
    }
    // 302, 8
    jamonWriter.write("    ############################################################################\n    # Register Field Variables\n    ############################################################################\n\n");
    // 307, 1
    for (Register r : regs )
    {
      // 308, 1
      {
        // 308, 1
        __jamon_innerUnit____regflds(jamonWriter, r , __indent);
      }
      // 308, 23
      jamonWriter.write("\n");
    }
    // 309, 8
    jamonWriter.write("    ############################################################################\n    # Public Commands\n    ############################################################################\n\n    proc get_bit {{buffer} {csr} {field}} {\n        upvar #0 [format \"::");
    // 315, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 315, 42
    jamonWriter.write("::%s_b_%s\" $csr $field] U_b\n        if {[catch {set value [testbit $buffer $U_b]}] != 0} then {\n            error \"bad single-bit field \\\"${csr}.${field}\\\"\"\n        }\n        return -code ok $value\n\n    };  # end get_bit\n\n    proc get_field {{buffer} {csr} {field}} {\n        upvar #0 [format \"::");
    // 324, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 324, 42
    jamonWriter.write("::%s_h_%s\" $csr $field] U_h\n        upvar #0 [format \"::");
    // 325, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 325, 42
    jamonWriter.write("::%s_l_%s\" $csr $field] U_l\n        if {[catch {set width [expr {1 + ($U_h - $U_l)}]}] != 0} then {\n            error \"bad multi-bit field \\\"${csr}.${field}\\\"\"\n        }\n        set mask [sub [lshift 1 $width] 1]\n        return -code ok [bitand [rshift $buffer $U_l] $mask]\n\n    };  # end get_field\n\n    proc set_bit {{buffer} {csr} {field} {value}} {\n        upvar #0 [format \"::");
    // 335, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 335, 42
    jamonWriter.write("::%s_b_%s\" $csr $field] U_b\n        set buf $buffer\n        if { ( ( $value == 0 ) && ( [catch {clearbit buf $U_b}] != 0 ) ) ||\n             ( ( $value == 1 ) && ( [catch {setbit buf $U_b}] != 0 ) ) } then {\n            error \"bad single-bit field \\\"${csr}.${field}\\\"\"\n        } elseif { ( $value != 0 ) && ( $value != 1 ) } then {\n            error [format \"bad value \\\"%s\\\"\" [tostr $value 16]]\n        }\n        return -code ok $buf\n\n    };  # end get_bit\n\n    proc set_field {{buffer} {csr} {field} {value}} {\n        upvar #0 [format \"::");
    // 348, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 348, 42
    jamonWriter.write("::%s_BITS\" $csr] U_bits\n        upvar #0 [format \"::");
    // 349, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 349, 42
    jamonWriter.write("::%s_h_%s\" $csr $field] U_h\n        upvar #0 [format \"::");
    // 350, 29
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 350, 42
    jamonWriter.write("::%s_l_%s\" $csr $field] U_l\n        set buf $buffer\n        if {[catch {set width [expr {1 + ($U_h - $U_l)}]}] != 0} then {\n            error \"bad multi-bit field \\\"${csr}.${field}\\\"\"\n        }\n        set mask [sub [lshift 1 $width] 1]\n        if { [lt $value 0] || [gt $value $mask] } then {\n            error [format \"bad value \\\"%s\\\"\" [tostr $value 16]]\n        }\n        set mask [bitnot [lshift $mask $U_l] $U_bits]\n        return -code ok [bitor [bitand $buffer $mask] [lshift $value $U_l]]\n\n    };  # end get_field\n\n};  # end namespace ::");
    // 364, 23
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(pakkage), jamonWriter);
    // 364, 36
    jamonWriter.write("\n");
  }
  
  
  // 175, 1
  private void __jamon_innerUnit____xdisplay(final java.io.Writer jamonWriter, final Number i, final int w, final boolean bignum)
    throws java.io.IOException
  {
    // 181, 1
    
int nibbles = (int) Math.ceil(w / 4.0);
String number = String.format(String.format("0x%%0%dx", nibbles), i);

    // 185, 1
    if (bignum )
    {
      // 185, 15
      jamonWriter.write("[fromstr ");
      // 185, 24
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(number), jamonWriter);
      // 185, 36
      jamonWriter.write("]");
    }
    // 185, 37
    else
    {
      // 185, 44
      jamonWriter.write("[expr {");
      // 185, 51
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(number), jamonWriter);
      // 185, 63
      jamonWriter.write("}]");
    }
  }
  
  
  // 150, 1
  private void __jamon_innerUnit____strfaddr(final java.io.Writer jamonWriter, final int addr)
    throws java.io.IOException
  {
    // 154, 1
    {
      // 154, 1
      __jamon_innerUnit____xdisplay(jamonWriter, addr, addrBits , false);
    }
  }
  
  
  // 123, 1
  private void __jamon_innerUnit____setindent(final java.io.Writer jamonWriter, final StringBuilder i, final int w)
    throws java.io.IOException
  {
    // 128, 1
    
i.delete(0, i.length());
for (int j = 0; j < w; j++) {
    for (int k = 0; k < __TCL_INDENT; k++) {
        i.append(" ");
    }
}

  }
  
  
  // 67, 1
  private void __jamon_innerUnit____enum(final java.io.Writer jamonWriter, final ConstantsEnum e)
    throws java.io.IOException
  {
    // 71, 1
    for (ConstantsEnumValue c : e.values )
    {
      // 72, 1
      {
        // 72, 1
        __jamon_innerUnit____decl(jamonWriter, c.getVerilogName().toUpperCase(), null, __DECL_BASE_WIDTH , "variable", __indent);
      }
      // 72, 99
      jamonWriter.write(" ");
      // 73, 1
      {
        // 73, 1
        __jamon_innerUnit____xdisplay(jamonWriter, c.getEncoding(), 1, true );
      }
      // 73, 60
      jamonWriter.write("\n");
    }
  }
  
  
  // 80, 1
  private void __jamon_innerUnit____regflds(final java.io.Writer jamonWriter, final Register r, final StringBuilder i)
    throws java.io.IOException
  {
    // 85, 1
    
Collection<RegisterField> fields = r.getSortedFields(false, true, false, false);

    // 88, 1
    if (fields == null )
    {
      // 88, 23
      jamonWriter.write("\n");
      // 89, 1
      throw new Error(r.getName() + " contains overlapping fields");
    }
    // 91, 1
    for (RegisterField f : fields )
    {
      // 92, 1
      if (f.len == 1 )
      {
        // 93, 1
        {
          // 93, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), "_b_" + f.desc, __DECL_DEFAULT_WIDTH, "variable", i );
        }
        // 93, 87
        jamonWriter.write(" ");
        // 94, 1
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.pos), jamonWriter);
        // 94, 12
        jamonWriter.write("\n");
      }
      // 95, 1
      else
      {
        // 96, 1
        {
          // 96, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), "_l_" + f.desc, __DECL_DEFAULT_WIDTH, "variable", i );
        }
        // 96, 87
        jamonWriter.write(" ");
        // 97, 1
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.pos), jamonWriter);
        // 97, 12
        jamonWriter.write("\n");
        // 98, 1
        {
          // 98, 1
          __jamon_innerUnit____decl(jamonWriter, r.getName(), "_h_" + f.desc, __DECL_DEFAULT_WIDTH, "variable", i );
        }
        // 98, 87
        jamonWriter.write(" ");
        // 99, 1
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.pos + (f.entries * f.len) - 1), jamonWriter);
        // 99, 38
        jamonWriter.write("\n");
        // 100, 1
        if (f.entries > 1 )
        {
          // 101, 1
          {
            // 101, 1
            __jamon_innerUnit____decl(jamonWriter, r.getName(), "_s_" + f.desc, __DECL_DEFAULT_WIDTH, "variable", i );
          }
          // 101, 87
          jamonWriter.write(" ");
          // 102, 1
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(f.len), jamonWriter);
          // 102, 12
          jamonWriter.write("\n");
        }
      }
    }
  }
  
  
  // 40, 1
  private void __jamon_innerUnit____decl(final java.io.Writer jamonWriter, final String name, final String suffix, final int w, final String keyword, final StringBuilder i)
    throws java.io.IOException
  {
    // 48, 1
    
StringBuilder decl = new StringBuilder();
if (keyword != null) {
    decl.append(keyword);
    decl.append(" ");
}
decl.append(prefix.toUpperCase());
decl.append(name);
if (suffix != null) {
    decl.append(suffix);
}

    // 60, 1
    if (i != null )
    {
      // 60, 18
      org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(i), jamonWriter);
    }
    // 61, 1
    org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format(String.format("%%-%ds", w), decl.toString())), jamonWriter);
  }
  
  
}
