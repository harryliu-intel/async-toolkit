#!/usr/bin/perl
# vim:et:sw=4:ts=4:tw=79:
#
# checkLib - checks the SWIG'd .so against the sdk.so to find 
#            undefined symbols

use strict;
use warnings;

use constant TRUE       => 1;
use constant FALSE      => 0;

my %SYMBOLS = (
    "PL_Sv" => "DEFINED",
    "PL_errgv" => "DEFINED",
    "PL_markstack_max" => "DEFINED",
    "PL_markstack_ptr" => "DEFINED",
    "PL_na" => "DEFINED",
    "PL_stack_base" => "DEFINED",
    "PL_stack_max" => "DEFINED",
    "PL_stack_sp" => "DEFINED",
    "PL_sv_undef" => "DEFINED",
    "PL_sv_yes" => "DEFINED",
    "PL_tmps_floor" => "DEFINED",
    "PL_tmps_ix" => "DEFINED",
    "Perl_Gthr_key_ptr" => "DEFINED",
    "Perl_Ierrgv_ptr" => "DEFINED",
    "Perl_Ireentrant_buffer_ptr" => "DEFINED",
    "Perl_Isv_undef_ptr" => "DEFINED",
    "Perl_Isv_yes_ptr" => "DEFINED",
    "Perl_Tmarkstack_max_ptr" => "DEFINED",
    "Perl_Tmarkstack_ptr_ptr" => "DEFINED",
    "Perl_Tna_ptr" => "DEFINED",
    "Perl_Tstack_base_ptr" => "DEFINED",
    "Perl_Tstack_max_ptr" => "DEFINED",
    "Perl_Tstack_sp_ptr" => "DEFINED",
    "Perl_Ttmps_floor_ptr" => "DEFINED",
    "Perl_Ttmps_ix_ptr" => "DEFINED",
    "Perl_av_fetch" => "DEFINED",
    "Perl_av_len" => "DEFINED",
    "Perl_av_pop" => "DEFINED",
    "Perl_av_push" => "DEFINED",
    "Perl_av_shift" => "DEFINED",
    "Perl_av_store" => "DEFINED",
    "Perl_av_undef" => "DEFINED",
    "Perl_call_pv" => "DEFINED",
    "Perl_croak" => "DEFINED",
    "Perl_croak_nocontext" => "DEFINED",
    "Perl_free_tmps" => "DEFINED",
    "Perl_get_av" => "DEFINED",
    "Perl_get_sv" => "DEFINED",
    "Perl_gv_HVadd" => "DEFINED",
    "Perl_gv_init" => "DEFINED",
    "Perl_gv_stashpv" => "DEFINED",
    "Perl_hv_delete" => "DEFINED",
    "Perl_hv_delete_ent" => "DEFINED",
    "Perl_hv_exists" => "DEFINED",
    "Perl_hv_exists_ent" => "DEFINED",
    "Perl_hv_fetch" => "DEFINED",
    "Perl_hv_iterinit" => "DEFINED",
    "Perl_hv_iterkey" => "DEFINED",
    "Perl_hv_iternext" => "DEFINED",
    "Perl_hv_iterval" => "DEFINED",
    "Perl_hv_store" => "DEFINED",
    "Perl_hv_store_ent" => "DEFINED",
    "Perl_hv_undef" => "DEFINED",
    "Perl_looks_like_number" => "DEFINED",
    "Perl_markstack_grow" => "DEFINED",
    "Perl_mg_find" => "DEFINED",
    "Perl_mg_get" => "DEFINED",
    "Perl_newAV" => "DEFINED",
    "Perl_newHV" => "DEFINED",
    "Perl_newRV_noinc" => "DEFINED",
    "Perl_newSV" => "DEFINED",
    "Perl_newSViv" => "DEFINED",
    "Perl_newSVpv" => "DEFINED",
    "Perl_newSVpvn" => "DEFINED",
    "Perl_newSVuv" => "DEFINED",
    "Perl_newXS" => "DEFINED",
    "Perl_pop_scope" => "DEFINED",
    "Perl_push_scope" => "DEFINED",
    "Perl_save_int" => "DEFINED",
    "Perl_stack_grow" => "DEFINED",
    "Perl_sv_2bool" => "DEFINED",
    "Perl_sv_2iv" => "DEFINED",
    "Perl_sv_2iv_flags" => "DEFINED",
    "Perl_sv_2mortal" => "DEFINED",
    "Perl_sv_2nv" => "DEFINED",
    "Perl_sv_2pv_flags" => "DEFINED",
    "Perl_sv_2uv" => "DEFINED",
    "Perl_sv_2uv_flags" => "DEFINED",
    "Perl_sv_bless" => "DEFINED",
    "Perl_sv_catpv" => "DEFINED",
    "Perl_sv_catpvf" => "DEFINED",
    "Perl_sv_catpvf_nocontext" => "DEFINED",
    "Perl_sv_derived_from" => "DEFINED",
    "Perl_sv_dump" => "DEFINED",
    "Perl_sv_free" => "DEFINED",
    "Perl_sv_isobject" => "DEFINED",
    "Perl_sv_isa" => "DEFINED",
    "Perl_sv_magic" => "DEFINED",
    "Perl_sv_newmortal" => "DEFINED",
    "Perl_sv_setiv" => "DEFINED",
    "Perl_sv_setnv" => "DEFINED",
    "Perl_sv_setpv" => "DEFINED",
    "Perl_sv_setpvf" => "DEFINED",
    "Perl_sv_setpvf_nocontext" => "DEFINED",
    "Perl_sv_setref_pv" => "DEFINED",
    "Perl_sv_setsv_flags" => "DEFINED",
    "Perl_sv_setuv" => "DEFINED",
    "Perl_sv_vsetpvfn" => "DEFINED",
    "Perl_warn" => "DEFINED",
    "Perl_warn_nocontext" => "DEFINED",
    "_exit" => "DEFINED",
    "_mcount" => "DEFINED",
    "__assert_fail" => "DEFINED",
    "__ctype_b_loc" => "DEFINED",
    "__errno_location" => "DEFINED",
    "__fxstat" => "DEFINED",
    "__progname" => "DEFINED",
    "__strdup" => "DEFINED",
    "__strtod_internal" => "DEFINED",
    "__strtol_internal" => "DEFINED",
    "__strtoul_internal" => "DEFINED",
    "atoi" => "DEFINED",
    "backtrace" => "DEFINED",
    "backtrace_symbols" => "DEFINED",
    "bsearch" => "DEFINED",
    "bcopy" => "DEFINED",
    "calloc" => "DEFINED",
    "ceil" => "DEFINED",
    "ceilf" => "DEFINED",
    "close" => "DEFINED",
    "connect" => "DEFINED",
    "ctime_r" => "DEFINED",
    "dup2" => "DEFINED",
    "execl" => "DEFINED",
    "exit" => "DEFINED",
    "fclose" => "DEFINED",
    "fdopen" => "DEFINED",
    "fgets" => "DEFINED",
    "floor" => "DEFINED",
    "fopen" => "DEFINED",
    "fopen64" => "DEFINED",
    "fprintf" => "DEFINED",
    "free" => "DEFINED",
    "fstat" => "DEFINED",
    "ftruncate" => "DEFINED",
    "fwrite" => "DEFINED",
    "getenv" => "DEFINED",
    "gethostbyname" => "DEFINED",
    "getpagesize" => "DEFINED",
    "getpid" => "DEFINED",
    "gettimeofday" => "DEFINED",
    "htonl" => "DEFINED",
    "htons" => "DEFINED",
    "ioctl" => "DEFINED",
    "lround" => "DEFINED",
    "malloc" => "DEFINED",
    "mcount" => "DEFINED",
    "memcmp" => "DEFINED",
    "memcpy" => "DEFINED",
    "memmove" => "DEFINED",
    "memset" => "DEFINED",
    "mmap" => "DEFINED",
    "nanosleep" => "DEFINED",
    "ntohl" => "DEFINED",
    "open" => "DEFINED",
    "pipe" => "DEFINED",
    "poll" => "DEFINED",
    "printf" => "DEFINED",
    "program_invocation_short_name" => "DEFINED",
    "pthread_attr_destroy" => "DEFINED",
    "pthread_attr_init" => "DEFINED",
    "pthread_attr_setschedparam" => "DEFINED",
    "pthread_attr_setschedpolicy" => "DEFINED",
    "pthread_cond_destroy" => "DEFINED",
    "pthread_cond_init" => "DEFINED",
    "pthread_cond_signal" => "DEFINED",
    "pthread_cond_timedwait" => "DEFINED",
    "pthread_cond_wait" => "DEFINED",
    "pthread_create" => "DEFINED",
    "pthread_equal" => "DEFINED",
    "pthread_exit" => "DEFINED",
    "pthread_getspecific" => "DEFINED",
    "pthread_mutex_destroy" => "DEFINED",
    "pthread_mutex_init" => "DEFINED",
    "pthread_mutex_lock" => "DEFINED",
    "pthread_mutex_timedlock" => "DEFINED",
    "pthread_mutex_unlock" => "DEFINED",
    "pthread_mutexattr_destroy" => "DEFINED",
    "pthread_mutexattr_init" => "DEFINED",
    "pthread_mutexattr_setpshared" => "DEFINED",
    "pthread_mutexattr_settype" => "DEFINED",
    "pthread_self" => "DEFINED",
    "putchar" => "DEFINED",
    "puts" => "DEFINED",
    "qsort" => "DEFINED",
    "random" => "DEFINED",
    "random_r" => "DEFINED",
    "read" => "DEFINED",
    "realloc" => "DEFINED",
    "recv" => "DEFINED",
    "round" => "DEFINED",
    "sched_get_priority_min" => "DEFINED",
    "sched_setscheduler" => "DEFINED",
    "sched_yield" => "DEFINED",
    "sem_destroy" => "DEFINED",
    "sem_init" => "DEFINED",
    "sem_post" => "DEFINED",
    "sem_timedwait" => "DEFINED",
    "sem_trywait" => "DEFINED",
    "sem_wait" => "DEFINED",
    "send" => "DEFINED",
    "sleep" => "DEFINED",
    "snprintf" => "DEFINED",
    "socket" => "DEFINED",
    "sprintf" => "DEFINED",
    "sscanf" => "DEFINED",
    "stdout" => "DEFINED",
    "strcasecmp" => "DEFINED",
    "strcat" => "DEFINED",
    "strchr" => "DEFINED",
    "strcmp" => "DEFINED",
    "strcpy" => "DEFINED",
    "strdup" => "DEFINED",
    "strerror" => "DEFINED",
    "strlen" => "DEFINED",
    "strncasecmp" => "DEFINED",
    "strncpy" => "DEFINED",
    "strrchr" => "DEFINED",
    "strstr" => "DEFINED",
    "strtod" => "DEFINED",
    "strtok" => "DEFINED",
    "strtol" => "DEFINED",
    "strtoll" => "DEFINED",
    "strtoul" => "DEFINED",
    "strtoull" => "DEFINED",
    "time" => "DEFINED",
    "fflush" => "DEFINED",
    "trunc" => "DEFINED",
    "vfork" => "DEFINED",
    "vfprintf" => "DEFINED",
    "vprintf" => "DEFINED",
    "vsnprintf" => "DEFINED",
    "vsprintf" => "DEFINED",
    "waitpid" => "DEFINED",
    "write" => "DEFINED",
    "shm_open" => "DEFINED",
    "abort" => "DEFINED",
    "perror" => "DEFINED",
);

printf("Looking for undefined symbols...\n");
open(FH, "-|", "nm -u ./SDK.so");
my $error = FALSE;
while (my $line = <FH>)
{
    # Removing leading and trailing whitespace.
    $line =~ s/^\s*(.*)\s*$/$1/;

    my $symbol = $line;
    # Remove the nm symbol type.
    $symbol =~ s/^U\s+//;
    # Take into account GLIBC symbol versioning support.
    $symbol =~ s/\@\@GLIBC_[0-9\.]*$//;

    if (!exists($SYMBOLS{$symbol}) || $SYMBOLS{$symbol} ne "DEFINED")
    {
        printf("\tFound %s\n", $symbol);
        $error = TRUE;
    }
}
close(FH);
if ($error)
{
    unlink("SDK.so");
}
exit($error);
