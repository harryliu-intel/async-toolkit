<?php
include "site.php";
if (session_id() === "") session_start();
ob_start();
date_default_timezone_set("America/Los_Angeles");
$date = getdate();
$year=$date["year"];
$limit=10000; # lines of data to display
#$authuser=preg_replace("/@.*/", "", $_SERVER["PHP_AUTH_USER"]);
#$diskroot="/p/work";
#$dirfile="lvedirs.txt";
#$lveroot=$authuser;
if (isset($_REQUEST["tlveroot"]) && $_REQUEST["tlveroot"] != "") {
    $lveroot=$_REQUEST["tlveroot"];
}
elseif (isset($_REQUEST["lveroot"])) {
    $lveroot=$_REQUEST["lveroot"];
}
elseif (isset($_SESSION["lveroot"]) and $_SESSION["lveroot"] != "") {
    $lveroot=$_SESSION["lveroot"];
}
$lveroot=str_replace("$diskroot/", "", $lveroot);
if (preg_match(":^$lverootregexp:", $lveroot)) {
    $lveroot=preg_replace(":^$lverootregexp:", "", $lveroot);
}
function datetime2time($str) {
}

$_SESSION["lveroot"]=$lveroot;
$db=false;
$dbprefix="";
$dbmstat=array( "mtime" => 0);
if (is_dir("$diskroot/$lveroot")) {
    if(!$skipmysql) {
    $rdb=$rdb=new PDO("mysql:dbname=lve;host=tsyvweb03", "lve", "lve");
    if ( $rdb ) {
        $dbroot=canon("$diskroot/".$lveroot);
        foreach ($rdb->query("select prefix from root where root='$dbroot'") as $row)
            $dbprefix=$row["prefix"];
        if ($dbprefix !== "") {
            $db=$rdb;
            $dbprefix = $dbprefix."_";
            foreach ($db->query("select unix_timestamp(datetime) from ${dbprefix}cells where datetime order by datetime") as $row) {
                $dbmstat["mtime"] = intval($row["unix_timestamp(datetime)"]);
            }
        }
    }
    }
    if ($dbprefix === "") {
        if (is_readable("$diskroot/"."$lveroot/lvedb.db")) {
            $db=new SQLite3("$diskroot/"."$lveroot/lvedb.db");
            if ($db) $dbmstat=stat("$diskroot/$lveroot/lvedb.db");
        }
    }
}
if ( ! $db ) {
    $db=false;
}
else {
}
$rawtable=$dbprefix."raw";
$cellstable=$dbprefix."cells";
$tasklist=array(
    "antenna"=>0,
    "extract"=>0,
    "frc"=>0,
    "hdrc"=>0,
    "hlvs"=>0,
    "jlvs"=>0,
    "alint"=>1,
    "lib"=>1,
    "aspice"=>2,
    "asta"=>1,
    "hsim"=>2,
    "xa"=>2,
    "hspice"=>2,
    "slint"=>1,
    "totem"=>2,
    "rte"=>3);
//create the color palette here
$color = array ( "PASS" => "white",
			 "NA" => "white",
                         "FAIL" => "red",
                         "FAIL_NEWBUMP" => "orange",
                         "FAIL_MNOISE" => "lightcoral",
                         "WARNING" => "orange",
                         "NOT_TESTED" => "lightblue",
			 "INCOMPLETE" => "lightblue",
                         "SIGNOFF" => "yellow",
                         "OTHER" => "lightgreen"
                         );

function canon ($path) {
    global $cwdpath;
    $x=popen("cd $path; $cwdpath", "r");
    $p=fread($x, 2048);
    pclose($x);
    return(str_replace("\n", "", $p));
}

function summarizeStatus($all) {
    $c=count($all);
    if (isset($all["PASS"]) and $c==1 ) return "PASS";
    if (isset($all["FAIL"])) return "FAIL";
    if (isset($all["FAIL_NEWBUMP"])) return "FAIL_NEWBUMP";
    if (isset($all["FAIL_MNOISE"])) return "FAIL_MNOISE";
    if (isset($all["WARNING"])) return "WARNING";
    if (isset($all["SIGNOFF"])) return "SIGNOFF";
    if (isset($all["NA"]) and isset($all["PASS"])) return "PASS";
    if (isset($all["NA"])) return "NA";
    return "NOT_TESTED";
}
function navbar() {
   echo '<!-- ========== START OF NAVBAR ========== -->';
   echo '<A NAME="navbar_top"><!-- --></A>';
   echo '<TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0">';
   echo '<TR>';
   echo '<TD COLSPAN=2 BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><A NAME="navbar_top_firstrow"><!-- --></A>';
   echo '<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="3">';
   echo '  <TR ALIGN="center" VALIGN="top">';
   echo '  <TD CLASS="NavBarCell1">';
   echo '  <A HREF="index.php"><B>Index</B></A></TD>';
   echo '<TD CLASS="NavBarCell1"><A HREF="doc/index.html" target="lvehelp"><B>Help Doc</B></A></TD>';
   echo '  <TD CLASS="NavBarCell1"><A HREF="statistics.php"><B>Statistics</B></A></TD>';
   echo '  </TR>';
   echo '</TABLE>';
   echo '</TD>';
   echo '<TD ALIGN="right" VALIGN="top" ROWSPAN=3></TD>';
   echo '</TR>';
   echo '</TR>';
   echo '</TABLE>';
   echo '<!-- =========== END OF NAVBAR =========== -->';
   echo ' <br>';
}

function globalheader($title) {
    global $year;
    global $lveroot;
    $texttitle=preg_replace("/<[^>]*>/", "", $title, 1);
    $texttitle=preg_replace("/<[^>]*>/", "", $title);
    $title=preg_replace("/>/", " style='margin-bottom: 2px;'>", $title, 1);
    if (preg_match("/>/", $title) == 0)
        $title="<h2 style='margin-bottom: 2px;'>$title</h2>";
?>
<HTML>
<HEAD>
<!-- Copyright 2012. Intel Corporation. All Rights Reserved -->
<!-- Generated by Layout Verification Engine on $date -->
<TITLE><?php echo $texttitle;?></TITLE>
<LINK REL ="stylesheet" TYPE="text/css" HREF="table.css" TITLE="Style">
<LINK REL ="stylesheet" TYPE="text/css" HREF="lve.css" TITLE="Style">
<META http-equiv=Content-Type content="text/html; charset=utf-8">
</HEAD>
<BODY BGCOLOR="#ffffff">
<!--TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0">
<TR>
<TD><TD ALIGN="LEFT" HEIGHT="90"><IMG SRC="logo.png " WIDTH="250" HEIGHT="90" ALT="Intel" BORDER="0" align="left"></A>
</TD>
</TR>
</TABLE-->
<?php navbar(); ?>
<P>
<CENTER>
<?php echo $title;?>
</CENTER>
<?php
if ($title != "Analog Verification") {
    print "<center>Lve Root $lveroot</center>";
}
}

function footer() {
   global $year;
   echo "<HR>\n";
   echo "<i>CONFIDENTIAL AND PROPRIETARY DATA of Intel Corporation.\n";
   echo "&copy Copyright $year. All Rights Reserved<br>\n";
   echo "This package contains valuable trade secrets and proprietary information of\n";
   echo "Intel Corporation, and is protected by U.S. and international laws\n";
   echo "and/or treaties.</i>\n";
   echo "</BODY>\n";
   echo "</HTML>\n";
   ob_end_flush();
   exit(0);
}


function script_name () {
    $s = preg_replace(":\.php.*:", "", $_SERVER["REQUEST_URI"]);
    $s = preg_replace(":.*/:","", $s);
    return $s;
}

function diagnostics ($diag) {
    if (file_exists($diag)) {
        $fp=fopen($diag,"r");
        $build=array();
        $shortfile=preg_replace(":.*/:", "", $diag);
        $command="";
        while ($fp !== false and !feof($fp)) {
            $line=fgets($fp);
            $split=preg_split("/ /", $line);
            if ($split[0] == "started:") {
                array_shift($split);
                $started=join(" ", $split);
                $start=strtotime($started);
            }
            if ($split[0] == "finished:") {
                array_shift($split);
                $finished=join(" ", $split);
                $end=strtotime($finished);
            }
            if (isset($split[2]) and $split[1] == "Build:") {
                $build[$split[0]]=$split[2];
            }
            if ($split[0] == "Host") {
                $host=$line;
            }
            if ($split[0] == "Compute") {
                $comp=$line;
            }
            if ($split[0] == "command") {
                $command=$line;
            }
        }
       $dur=$end-$start;
       echo "<h3>Diagnostics: $shortfile</h3>";
       echo "Started: $started<br>";
       echo "Ended: $finished<br>";
       echo "Duration: $dur(s)<br>";
       foreach ($build as $key => $value) {
           echo "$key Build: $value<br>";
       }
       echo "$host<br>";
       echo "$comp<br>";
       if (isset($command)) echo "$command<br>";
       fclose($fp);
   }
}

function newbumpsheader ($faninout) {
 #new style
 if ($faninout) {
   $column="<th>Fanin</th><th>Fanout</th>";
 }else{
   $column="<th>node</th>";
 }
?>
<tr BGCOLOR="#CCCCFF">
<?php print $column;?>
<th>stdout</th>
<th>stderr</th>
<th>ThreshCC</th>
<th>ThreshTau (ps)</th>
<th>CC</th>
<th>Tau (ps)</th>
<th>Bump Direction</th>
<th>Bump %</th>
<th>Resp Direction</th>
<th>Resp %</th>
<th>Other Info</th>
</tr>
<?php
}

function bumpsheader () {
?>
<tr BGCOLOR="#CCCCFF">
<th>Node</th>
<th>Inv Nodes</th>
<th>stdout</th>
<th>stderr</th>
<th>CC</th>
<th>Tau (ps)</th>
<th>Bump Dn<br>(%,limit)</th>
<th>Bump Up<br>(%,limit)</th>
<th>Inv Bump Dn<br>(%,limit)</th>
<th>Inv Bump Up<br>(%,limit)</th>
</tr>
<?php
}

function shownewbumps ($bumps, $lveroot, $path, $task, $addresp) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="alint";
    $cnt=0;
    $skip=array("status","node","cc","tau", "fanin", "fanout", "threshCC","threshTau", "resp_up", "resp_dn", "bump_up","bump_dn","resp","additive_resp","additive_resp_up", "additive_resp_dn", "multi_noise_resp_up", "multi_noise_resp_dn");
    foreach ($bumps as $line) {
        unset($ret);
        $ret=parse_raw_line($line);
        $status=$ret["status"];
        $node="&nbsp;";
        if (isset($ret["node"])) $node=$ret["node"];
        $fanin="&nbsp;";
        if (isset($ret["fanin"])) $fanin=$ret["fanin"];
        $fanout="&nbsp;";
        if (isset($ret["fanout"])) $fanout=$ret["fanout"];
        $isfaninout=0;
        if ( isset($ret["fanout"]) or isset($ret["fanin"]) ) $isfaninout=1;
        if ( $cnt == 0 ) newbumpsheader($isfaninout);
        $cc="&nbsp;";
        if (isset($ret["cc"])) $cc=$ret["cc"];
        $tau="&nbsp;";
        if (isset($ret["tau"])) $tau=$ret["tau"];
        $threshCC="&nbsp;";
        if (isset($ret["threshCC"])) $threshCC=$ret["threshCC"];
        $threshTau="&nbsp;";
        if (isset($ret["threshTau"])) $threshTau=$ret["threshTau"];
        $bumpdir="&nbsp;";
        $respdir="&nbsp;";
        if ($status == "PASS") {
            $fail_type="pass";
        }elseif ($status == "FAIL") {
            $fail_type="fail";
        }else {
            $fail_type="";
        }
        foreach ($ret as $key=>$value) {
            if (!in_array($key,$skip) and $key != "" ) $fail_type = "$fail_type<br>$key=$value";
        }
        if (isset($ret["multi_noise_resp_dn"]) or isset($ret["multi_noise_resp_up"])) $fail_type = "$fail_type<br>multi_noise_analysis";
        
        $bump="&nbsp;";
        if (isset($ret["bump_dn"])) {
            $bump_split=preg_split("/\//",$ret["bump_dn"]);
            for($i=0 ; $i<count($bump_split) ; $i++) {
                 $bump_split[$i]=intval(preg_replace("/@.*/", "", $bump_split[$i]));
            }
            $bump=join(",", $bump_split);
            $bumpdir="dn";
        }
        elseif (isset($ret["bump_up"])) {
            $bump_split=preg_split("/\//",$ret["bump_up"]);
            for($i=0 ; $i<count($bump_split) ; $i++) {
                 $bump_split[$i]=intval(preg_replace("/@.*/", "", $bump_split[$i]));
            }
            $bump=join(",", $bump_split);
            $bumpdir="up";
        }
        if (isset($ret["resp_dn"])) $respdir="dn";
        if (isset($ret["resp_up"])) $respdir="up";
        if (isset($ret["additive_resp_dn"])) $respdir="dn";
        if (isset($ret["additive_resp_up"])) $respdir="up";
        if (isset($ret["multi_noise_resp_dn"])) $respdir="dn";
        if (isset($ret["multi_noise_resp_up"])) $respdir="up";
        if ($respdir == "&nbsp;") {
          if (isset($ret["bump_up"])) $respdir="dn";
          if (isset($ret["bump_dn"])) $respdir="up";
        }
        if ($bumpdir == "&nbsp;") {
          if ($respdir == "up") $bumpdir="dn";
          if ($respdir == "dn") $bumpdir="up";
        }
        $out="out";
        $err="err";
        $bin=0;
        if ( isset($ret["fanin"]) and (! eregi("\/", $fanin)) ) {
           #local node
           $node=$fanin;
        }
        elseif (  isset($ret["fanout"]) and (! eregi("\/", $fanout)) ) {
           #local node
           $node=$fanout;
        }
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/$task.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
            if (is_file("$diskroot/$lveroot/$path/${task}_PO.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/${task}_PO.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/${task}_PO.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/${task}_PO.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        $style=" style='background: $color[$status];'";
        $resp="&nbsp;";
        if (isset($ret["resp"]))  $resp=$ret["resp"];
        if (isset($ret["resp_up"]))  $resp=$ret["resp_up"];
        if (isset($ret["resp_dn"]))  $resp=$ret["resp_dn"];
        if (isset($ret["additive_resp"]))  $resp=$ret["additive_resp"];
        if (isset($ret["additive_resp_up"]))  $resp=$ret["additive_resp_up"];
        if (isset($ret["additive_resp_dn"]))  $resp=$ret["additive_resp_dn"];
        if (isset($ret["multi_noise_resp_up"]))  $resp=$ret["multi_noise_resp_up"];
        if (isset($ret["multi_noise_resp_dn"]))  $resp=$ret["multi_noise_resp_dn"];
        if ($isfaninout){
          print "<tr><td$style>$fanin<td$style>$fanout<td>$out<td>$err<td>$threshCC<td>$threshTau<td>$cc<td>$tau<td>$bumpdir<td>$bump<td>$respdir<td>$resp<td>$fail_type\n";
        }else{
          print "<tr><td$style>$node<td>$out<td>$err<td>$threshCC<td>$threshTau<td>$cc<td>$tau<td>$bumpdir<td>$bump<td>$respdir<td>$resp<td>$fail_type\n";
        }
        $cnt++;
        if ($cnt > $limit) {
            print "<tr><td colspan=8>Too many bumps to display, stopping at $limit";
            break;
        }
    }
}

function showbumps ($bumps, $lveroot, $path, $task) {
    global $limit;
    global $color;
    global $diskroot;
    bumpsheader();
    if (! isset($task)) $task="alint";
    $cnt=0;
    foreach ($bumps as $line) {
        $ret=parse_raw_line($line);
        $status=$ret["status"];
        $node=$ret["node"];
        $cc=$ret["cc"];
        $tau=$ret["tau"];
        $bump_dn=intval(preg_replace("/@.*/", "", $ret["bump_dn"]));
        $bump_up=intval(preg_replace("/@.*/", "", $ret["bump_up"]));
        $inv_node=$ret["inv_node"];
        $inv_bump_dn=intval(preg_replace("/@.*/", "", $ret["inv_bump_dn"]));
        $inv_bump_up=intval(preg_replace("/@.*/", "", $ret["inv_bump_up"]));
        unset($bump_dn_bound);
        unset($bump_up_bound);
        unset($inv_bump_dn_bound);
        unset($inv_bump_up_bound);
        unset($inv_bump_dn_bound);
        unset($inv_bump_up_bound);
        if (isset($ret["bump_dn_bound"])) {
            $bump_dn_bound=intval($ret["bump_dn_bound"]);
            $bump_up_bound=intval($ret["bump_up_bound"]);
            $inv_bump_dn_bound=$ret["inv_bump_dn_bound"];
            $inv_bump_up_bound=$ret["inv_bump_up_bound"];
            if ($inv_bump_dn_bound == "NA")
                unset($inv_bump_dn_bound);
            else
                $inv_bump_dn_bound=intval($inv_bump_dn_bound);
            if ($inv_bump_up_bound == "NA")
                unset($inv_bump_up_bound);
            else
                $inv_bump_up_bound=intval($inv_bump_up_bound);
        }
        $out="out";
        $err="err";
        $bin=0;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/$task.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        $style=" style='background: $color[$status];'";
        $stylebd=(isset($bump_dn_bound) and ($bump_dn > $bump_dn_bound)) ? $style : "";
        $stylebu=(isset($bump_up_bound) and ($bump_up > $bump_up_bound)) ? $style : "";
        $styleibd=(isset($inv_bump_dn_bound) and ($inv_bump_dn > $inv_bump_dn_bound)) ? $style : "";
        $styleibu=(isset($inv_bump_up_bound) and ($inv_bump_up > $inv_bump_up_bound)) ? $style : "";
        $bump_dn_bound = isset($bump_dn_bound) ? ",$bump_dn_bound" : "";
        $bump_up_bound = isset($bump_up_bound) ? ",$bump_up_bound" : "";
        $inv_bump_dn_bound = isset($inv_bump_dn_bound) ? ",$inv_bump_dn_bound" : "";
        $inv_bump_up_bound = isset($inv_bump_up_bound) ? ",$inv_bump_up_bound" : "";
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/bump_dn:$cc:$tau.png")) {
            $bump_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/bump_dn:$cc:$tau.png\">$bump_dn</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/bump_up:$cc:$tau.png")) {
            $bump_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/bump_up:$cc:$tau.png\">$bump_up</a>";
        }
        print "<tr><td$style>$node<td>$inv_node<td>$out<td>$err<td>$cc<td>$tau<td$stylebd>$bump_dn$bump_dn_bound<td$stylebu>$bump_up$bump_up_bound<td$styleibd>$inv_bump_dn$inv_bump_dn_bound<td$styleibu>$inv_bump_up$inv_bump_up_bound\n";
        $cnt++;
        if ($cnt > $limit) {
            print "<tr><td colspan=10>Too many bumps to display, stopping at $limit";
            break;
        }
    }
}

function delayheader () {
?>
<tr BGCOLOR="#CCCCFF">
<th>Node</th>
<th>stdout</th>
<th>stderr</th>
<th>CC</th>
<th>Tau (ps)</th>
<th>Delay Dn (ps)<br>(spec, slow, fast, limit)</th>
<th>Delay Up (ps)<br>(spec, slow, fast, limit)</th>
<th>Slew Dn (ps)<br>(slow, fast, limit)</th>
<th>Slew Up (ps)<br>(slow, fast, limit)</th>
<th>Skew Dn (ps)<br>(skew, limit)</th>
<th>Skew Up (ps)<br>(skew, limit)</th>
</tr>
<?php
}

function showdelays ($delays, $lveroot, $path, $task) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="alint";
    delayheader();
    $cnt=0;
    foreach ($delays as $line) {
        $split=preg_split("/ /",$line);
        $status=array_shift($split);
        $ret=parse_raw_line($line);
        $node=$ret["node"];
        $cc=$ret["cc"];
        $tau=$ret["tau"];
        $delay_dn=intval(preg_replace("/@.*/", "", $ret["delay_dn"]));
        $delay_up=intval(preg_replace("/@.*/", "", $ret["delay_up"]));
        $slow_delay_dn=intval(preg_replace("/@.*/", "", $ret["slow_delay_dn"]));
        $slow_delay_up=intval(preg_replace("/@.*/", "", $ret["slow_delay_up"]));
        $fast_delay_dn=intval(preg_replace("/@.*/", "", $ret["fast_delay_dn"]));
        $fast_delay_up=intval(preg_replace("/@.*/", "", $ret["fast_delay_up"]));
        $skew_dn=intval(preg_replace("/@.*/", "", $ret["skew_dn"]));
        $skew_up=intval(preg_replace("/@.*/", "", $ret["skew_up"]));
        $slow_slew_dn=intval(preg_replace("/@.*/", "", substr($split[14],13)));
        $slow_slew_up=intval(preg_replace("/@.*/", "", substr($split[15],13)));
        $fast_slew_dn=intval(preg_replace("/@.*/", "", substr($split[16],13)));
        $slow_slew_dn=intval(preg_replace("/@.*/", "", $ret["slow_slew_dn"]));
        $slow_slew_up=intval(preg_replace("/@.*/", "", $ret["slow_slew_up"]));
        $fast_slew_dn=intval(preg_replace("/@.*/", "", $ret["fast_slew_dn"]));
        $fast_slew_up=intval(preg_replace("/@.*/", "", $ret["fast_slew_up"]));
        unset($delay_bound_dn);
        unset($delay_bound_up);
        unset($skew_bound);
        unset($slew_bound);
        if ( isset($ret["delay_bound_up"])) {
            $delay_bound_dn=round(floatval($ret["delay_bound_dn"]));
            $delay_bound_up=round(floatval($ret["delay_bound_up"]));
            $skew_bound=round(floatval($ret["skew_bound"]));
            $slew_bound=round(floatval($ret["slew_bound"]));
        }
        $out="out";
        $err="err";
        $bin=0;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/$task.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        $style=" style='background: $color[$status];'";
        $styledd=((isset($delay_bound_dn) and (($delay_bound_dn < $slow_delay_dn) or ($delay_bound_dn < $fast_delay_dn))) ? $style : "");
        $styleud=((isset($delay_bound_up) and ($delay_bound_up < $slow_delay_up or $delay_bound_up < $fast_delay_up)) ? $style : "");
        $styledl=((isset($slew_bound) and ($slew_bound < $slow_slew_dn or $slew_bound < $fast_slew_dn)) ? $style : "");
        $styleul=((isset($slew_bound) and ($slew_bound < $slow_slew_up or $slew_bound < $fast_slew_up)) ? $style : "");
        $styledk=((isset($skew_bound) and $skew_bound < $skew_dn) ? $style : "");
        $styleuk=((isset($skew_bound) and $skew_bound < $skew_up) ? $style : "");
        $delay_bound_dn = isset($delay_bound_dn) ? ",$delay_bound_dn" : "";
        $delay_bound_up = isset($delay_bound_up) ? ",$delay_bound_up" : "";
        $skew_bound = isset($skew_bound) ? ",$skew_bound" : "";
        $slew_bound = isset($slew_bound) ? ",$slew_bound" : "";
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/slow_dn:$cc:$tau.png")) {
            $slow_delay_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/slow_dn:$cc:$tau.png\">$slow_delay_dn</a>";
            $slow_slew_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/slow_dn:$cc:$tau.png\">$slow_slew_dn</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/slow_up:$cc:$tau.png")) {
            $slow_delay_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/slow_up:$cc:$tau.png\">$slow_delay_up</a>";
            $slow_slew_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/slow_up:$cc:$tau.png\">$slow_slew_up</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/fast_dn:$cc:$tau.png")) {
            $fast_delay_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_dn:$cc:$tau.png\">$fast_delay_dn</a>";
            $fast_slew_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_dn:$cc:$tau.png\">$fast_slew_dn</a>";
            $skew_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_dn:$cc:$tau.png\">$skew_dn</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/fast_up:$cc:$tau.png")) {
            $fast_delay_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_up:$cc:$tau.png\">$fast_delay_up</a>";
            $fast_slew_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_up:$cc:$tau.png\">$fast_slew_up</a>";
            $skew_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/fast_up:$cc:$tau.png\">$skew_up</a>";
        }
        print "<tr><td$style>$node<td>$out<td>$err<td>$cc<td>$tau<td$styledd>$delay_dn,$slow_delay_dn,$fast_delay_dn$delay_bound_dn<td$styleud>$delay_up,$slow_delay_up,$fast_delay_up$delay_bound_up<td$styledl>$slow_slew_dn,$fast_slew_dn$slew_bound<td$styleul>$slow_slew_up,$fast_slew_up$slew_bound<td$styledk>$skew_dn$skew_bound<td$styleuk>$skew_up$skew_bound\n";
        $cnt++;
        if ($cnt > $limit) {
            print "<tr><td colspan=10>Too many delays to display, stopping at $limit";
            break;
        }
    }
}

function leakageheader () {
?>
<tr BGCOLOR="#CCCCFF">
<th>Node</th>
<th>stdout</th>
<th>stderr</th>
<th>Leak Dn (%)</th>
<th>Leak Up (%)</th>
<th>Leak Bound (%)</th>
</tr>
<?php
}

function showleakage ($leakage, $lveroot, $path, $task) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="alint";
    leakageheader();
    $cnt=0;
    foreach ($leakage as $line) {
        $split=preg_split("/ /",$line);
        $status=array_shift($split);
        $ret=parse_raw_line($line);
        $node=$ret["node"];
        $leak_dn=intval(preg_replace("/@.*/", "", $ret["leak_dn"]));
        $leak_up=intval(preg_replace("/@.*/", "", $ret["leak_up"]));
        unset($leak_bound);
        if (isset($ret["leak_bound"])) $leak_bound=intval($ret["leak_bound"]);
        $out="out";
        $err="err";
        $bin=0;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/$task.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        $style=" style='background: $color[$status];'";
        $styled=(isset($leak_bound) and ($leak_bound < $leak_dn)) ? $style : "";
        $styleu=(isset($leak_bound) and ($leak_bound < $leak_up)) ? $style : "";
        if (! isset($leak_bound)) $leak_bound="Not Available";
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/leak_dn.png")) {
            $leak_dn="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/leak_dn.png\">$leak_dn</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/$task.bin.$bin/$node/leak_up.png")) {
            $leak_up="<a href=\"/work/$lveroot/$path/$task.bin.$bin/$node/leak_up.png\">$leak_up</a>";
        }
        print "<tr><td$style>$node<td>$out<td>$err<td$styled>$leak_dn<td$styleu>$leak_up<td>$leak_bound";
        $cnt++;
        if ($cnt > $limit) {
            print "<tr><td colspan=10>Too many leakage lines to display, stopping at $limit";
            break;
        }
    }
}

function emheader () {
?>
<tr BGCOLOR="#CCCCFF">
<th>Node</th>
<th>stdout</th>
<th>stderr</th>
<th>CC</th>
<th>Tau (ps)</th>
<th>Frequency (GHz)</th>
<th>Resistor</th>
<th>Layer</th>
<th>Width (nm)</th>
<th>Avg</th>
<th>Rms</th>
</tr>
<?php
}

function showem ($em, $lveroot, $path, $task) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="alint";
    emheader();
    $c=count($em);
    $emlimit=$limit;
    $start=$_SESSION["emstart"];
    if ($emlimit <= $c) $_SESSION["emstart"]=$start+$c;
    $cnt=0;
    $llimit=$emlimit+$start;
    $prev=$start-$limit;
    if ($start > 0) print "<tr><td colspan=11>starting at line $start : <a href=\"em.php?path=$path&start=$prev\">Previous</a>";
    foreach ($em as $line) {
        $split=preg_split("/ /",$line);
        $status=array_shift($split);
        $node=substr($split[3], 5);
        $cc=substr($split[4],3);
        $tau=substr($split[5],4);
        $r=substr($split[6],9);
        list($resistor,$layer,$width)=preg_split('/\./', $r);
        $r=preg_split('/\./', $r);
        $c=count($r);
        $resistor=$r[0];
        for ($n=1; $n < $c-2; $n++) $resistor .= ".".$r[$n];
        $width=$r[$c-1];
        $layer=$r[$c-2];
        $freq=substr($split[7], 8);
        $avg=substr($split[8],7);
        $rms=substr($split[9],7);
        $out="out";
        $err="err";
        $bin=0;
        $cnt++;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                if (filesize("$diskroot/$lveroot/$path/$task.bin.$abin/$node/err") > 0)
                    $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        print "<tr style='background: $color[$status];'><td>$node<td>$out<td>$err<td>$cc<td>$tau<td>$freq<td>$resistor<td>$layer<td>$width<td>$avg<td>$rms";
        if ($cnt >= $emlimit) {
            print "<tr><td colspan=11>Too many em lines to display, stopping at $llimit: <a href=\"em.php?path=$path\">Next</a>";
            break;
        }
    }
}

$matchcount=0;
$ccc=0;
#$okem=array("==","~",">","<","<=",">=","&&","(",")","||");
$okop=array("&&","(",")","||");
$compare=array("==","~",">","<","<=",">=");
$emitems=array(
    "resistor" => "string",
    "node" => "string",
    "em_freq" => "float",
    "em_avg" => "float",
    "em_rms" => "float",
    "tau" => "int",
    "cc" => "int",
    "layer" => "string",
    "width" => "int",
);

$leakitems=array(
    "leak_dn" => "string",
    "leak_up" => "string",
    "node" => "string",
);

$bumpitems=array(
    "node" => "string",
    "inv_nodes" => "string",
    "cc" => "int",
    "tau" => "int",
    "bump_dn" => "string",
    "bump_up" => "string",
    "inv_bump_up" => "string",
    "inv_bump_dn" => "string",
);

$delaysitems=array(
    "node" => "string",
    "cc" => "int",
    "tau" => "int",
    "fast_delay_dn" => "int",
    "fast_delay_up" => "int",
    "slow_delay_dn" => "int",
    "slow_delay_up" => "int",
    "delay_dn" => "int",
    "delay_up" => "int",
    "slew_up" => "int",
    "slew_dn" => "int",
    "skew_up" => "int",
    "skew_dn" => "int",
);

$libdelaysitems=array(
    "node" => "sstring",
    "cc" => "int",
    "tau" => "int",
#    "pincap" => "float",
#    "gatecap" => "float",
#    "wirecap" => "float",
#    "diffcap" => "float",
#    "direction" => "string",
#    "loadcap" => "float",
    "slow_delay_dn" => "float",
    "slow_delay_up" => "float",
    "slow_slew_dn" => "float",
    "slow_slew_up" => "float",
);

$bumpsitems=array(
    "node" => "string",
    "cc" => "int",
    "tau" => "int",
    "bump_dn" => "int",
    "bump_up" => "int",
    "inv_node" => "int",
    "inv_bump_dn" => "int",
    "inv_bump_up" => "int",
    "bump_dn_bound" => "int",
    "bump_up_bound" => "int",
    "inv_bump_dn_bound" => "int",
    "inv_bump_up_bound" => "int",
);

$newbumpsitems=array(
    "node" => "string",
    "cc" => "int",
    "tau" => "int",
    "bump_dn" => "int",
    "bump_up" => "int",
    "resp" => "int",
    "additive_resp" => "int",
    "power_sag" => "float",
    "source_pvt" => "string",
    "fail_type" => "string",
    "fanout_type" => "string",
    "fanout_cell" => "string",
    "fanout_info" => "string",
);

$leakageitems=array(
    "node" => "string",
    "leak_dn" => "int",
    "leak_up" => "int",
    "leak_bound" => "int",
);

$lasttoken="";
$lastkey="";

function ok ($v, $items) {
    global $okop;
    global $compare;
    global $lasttoken;
    global $lastkey;
    $rv=0;
    if (array_key_exists($v, $items)) { $lastkey=$v; $rv=1;}
    if (in_array($v, $compare) || in_array($v, $okop)) $rv=1;
    if (in_array($lasttoken, $compare) && (isset($items[$lastkey]) && $items[$lastkey] == "string")) $rv=1;
    if (! in_array($lasttoken,$compare) && in_array($v, $okop)) $rv=1;
    if (in_array($lasttoken,$compare) && is_numeric($v)) $rv=1;
    $lasttoken=$v;
    return $rv;
}

function filtermatch($line,$filter,$items) {
    global $matchcount;
    global $ccc;
    $l=$line;
    $result=true;
    if ($filter == "") return true;
    $matchcount++;
    # special case for em
    if (array_key_exists("em_avg", $items)) {
        $lsplit=preg_split("/ /", $line);
        $nlsplit=array();
        foreach ($lsplit as $element) {
            if (preg_match("/^resistor=(\S+)$/", $element, $s)) {
                $rsplit=preg_split("/\./", $s[1]);
                $width=array_pop($rsplit);
                $layer=array_pop($rsplit);
                $r=join(",",$rsplit);
                $nlsplit[]="resistor=$r";
                $nlsplit[]="layer=$layer";
                $nlsplit[]="width=$width";
            }
            else {
                $nlsplit[]=$element;
            }
        }
        $line=join(" ", $nlsplit);
    }
    foreach( $items as $value => $type) {
#        if ($matchcount==1) print "VALUE=$value<br>";
        if (preg_match("/\b$value\s*([<>=~]+)\s*([^\s]+)/", $filter, $m)) {
            $op=$m[1];
            if ($type == "string") {
#                if ($matchcount == 1) print "S \"$m[2]\"<br>";
                eval("\$v=\"$m[2]\";");
            }
            else {
                eval("\$v=$m[2];");
            }
#            if ($matchcount==1) print "V=$v $value $type<br>";
            if (preg_match("/ $value=([^ ]+)/", $line, $matches)) {
                if ($type == "string") {
                    eval("\$$value=\"$matches[1]\";");
                }
                else {
                    $matches[1]=preg_replace("/@.*/", "", $matches[1]);
                    eval("\$$value=$matches[1];");
                }
#                if ($matchcount==1) print "\$$value=$matches[1] type=$type op=$op<br>";
#                if ($ccc==0 && $value == "resistor") print("\$$value=$matches[1];<br>");
#                $ccc++;
            }
            else {
                eval("\$$value=0;");
            }
            eval("\$x=\$$value;");
            if ($op == "~") {
                $filter = preg_replace("/$value ~ [^ ]+/", "preg_match(\"/$m[2]/\",\"\$$value\")", $filter);
            }
            else {
#                $filter = str_replace("$value", "\$$value", $filter);
                $filter = preg_replace("/\b$value\b/", "\$$value", $filter);
                if ($type == "string") {
                    $filter = str_replace("$m[2]", "\"$m[2]\"", $filter);
                }
            }
        }
    }
    eval("\$result=($filter);");
#    if ($matchcount==1) print("\$result=($filter) : $result : $l<br>");
    return $result;
}

function validfilter ($filter, $items) {
    if ($filter == "") return $filter;
    $filtersplit=preg_split("/([\(\)&|=><~]+)/", $filter,-1,PREG_SPLIT_DELIM_CAPTURE);
    $c=count($filtersplit);
    $newfilter="";
    $okfilter=true;
    $message="";
    foreach($filtersplit as $v ) {
        $v = str_replace(" ", "", $v);
        if ($v != "" && ok($v,$items)) {
            $newfilter .= "$v ";
        }
        elseif ($v != "") {
            $okfilter=false;
            $message .= " $v";
        }
    }
    if ($okfilter) $filter=$newfilter;
    else {
        print "<font size=\"+1\" color=red>Invalid filter $filter at $message</font><br>";
        $filter="";
    }
    return $filter;
}

function getem ($lveroot,$path,$task) {
    global $limit;
    global $emitems;
    global $diskroot;
    if (! isset($task)) $task="alint";
    # read the raw file
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $em=array();
    $cnt=-1;
    $filter="";
    # deal with filter, if any
    if (isset($_SESSION["emfilter"])) $filter=validfilter($_SESSION["emfilter"], $emitems);
    if (!isset($_SESSION["lastemfilter"])) $_SESSION["lastemfilter"]="";
    # if filter changes, always start at line 0
    if ($_SESSION["emfilter"] != $_SESSION["lastemfilter"]) {
        $_SESSION["emstart"]=0;
        $_SESSION["lastemfilter"]=$_SESSION["emfilter"];
    }
    # put the matching lines into the em array
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        if (strstr($line, "em_avg=") !== false && strstr($line, "error=") === false && filtermatch($line,$filter,$emitems)) {
            $cnt++;
            if ($cnt < $_SESSION["emstart"]) continue;
            $em[]=$line;
            if ($cnt >= $limit+$_SESSION["emstart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $em;
}

function getbumps ($lveroot,$path,$task) {
    global $limit;
    global $bumpsitems;
    global $diskroot;
    if (! isset($task)) $task="alint";
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $bumps=array();
    $cnt=-1;
    $filter="";
    if (isset($_SESSION["bumpsfilter"])) $filter=validfilter($_SESSION["bumpsfilter"], $bumpsitems);
    if (!isset($_SESSION["lastbumpsfilter"])) $_SESSION["lastbumpsfilter"]="";
    if ($_SESSION["bumpsfilter"] != $_SESSION["lastbumpsfilter"]) {
        $_SESSION["bumpsstart"]=0;
        $_SESSION["lastbumpsfilter"]=$_SESSION["bumpsfilter"];
    }
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        if (strstr($line, "inv_bump_dn=") !== false && strstr($line, "error=") === false && filtermatch($line,$filter,$bumpsitems)) {
            $cnt++;
            if ($cnt < $_SESSION["bumpsstart"]) continue;
            $bumps[]=$line;
            if ($cnt >= $limit+$_SESSION["bumpsstart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $bumps;
}

function getnewbumps ($lveroot,$path,$task, $addresp) {
    global $limit;
    global $newbumpsitems;
    global $diskroot;
    $resp_key="resp";
    if (isset($addresp) and $addresp==1) $resp_key="additive_resp";
    if (! isset($task)) $task="alint";
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $bumps=array();
    $cnt=-1;
    $filter="";
    if (isset($_SESSION["newbumpsfilter"])) $filter=validfilter($_SESSION["newbumpsfilter"], $newbumpsitems);
    if (!isset($_SESSION["lastnewbumpsfilter"])) $_SESSION["lastnewbumpsfilter"]="";
    if ($_SESSION["newbumpsfilter"] != $_SESSION["lastnewbumpsfilter"]) {
        $_SESSION["newbumpsstart"]=0;
        $_SESSION["lastnewbumpsfilter"]=$_SESSION["newbumpsfilter"];
    }
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        $matchline=0;
        if (strstr($line, " resp=") !== false ) $matchline=1;
        if (strstr($line, " resp_up=") !== false ) $matchline=1;
        if (strstr($line, " resp_dn=") !== false ) $matchline=1;
        if (strstr($line, " multi_noise_resp_up=") !== false ) $matchline=1;
        if (strstr($line, " multi_noise_resp_dn=") !== false ) $matchline=1;
        if (!isset($addresp) or $addresp==0) { 
          if (strstr($line, "additive_resp") == false && strstr($line, " fail_type=") !== false ) $matchline=1;
        }
#    #   if ((strstr($line, " $resp_key=") !== false || strstr($line, " fail_type=") !== false) && filtermatch($line,$filter,$newbumpsitems)) {
        if ( $matchline==1 && filtermatch($line,$filter,$newbumpsitems)) {
#         if ((strstr($line, " $resp_key=") !== false || strstr($line, " fail_type=") !== false) && filtermatch($line,$filter,$newbumpsitems)) {
            $cnt++;
            if ($cnt < $_SESSION["newbumpsstart"]) continue;
            $bumps[]=$line;
            if ($cnt >= $limit+$_SESSION["newbumpsstart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $bumps;
}

function getdelays ($lveroot,$path,$task) {
    global $limit;
    global $delaysitems;
    global $diskroot;
    if (!isset($task)) $task="alint";
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $delays=array();
    $cnt=-1;
    $filter="";
    # deal with filter, if any
    if (isset($_SESSION["delaysfilter"])) $filter=validfilter($_SESSION["delaysfilter"], $delaysitems);
    if (!isset($_SESSION["lastdelaysfilter"])) $_SESSION["lastdelaysfilter"]="";
    # if filter changes, always start at line 0
    if ($_SESSION["delaysfilter"] != $_SESSION["lastdelaysfilter"]) {
        $_SESSION["delaysstart"]=0;
        $_SESSION["lastdelaysfilter"]=$_SESSION["delaysfilter"];
    }
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        if (strstr($line, "delay_dn=") !== false && strstr($line, "error=") === false && filtermatch($line,$filter,$delaysitems)) {
            $cnt++;
            if ($cnt < $_SESSION["delaysstart"]) continue;
            $delays[]=$line;
            if ($cnt >= $limit+$_SESSION["delaysstart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $delays;
}

function getlibdelays ($lveroot,$path,$task) {
    global $limit;
    global $libdelaysitems;
    global $diskroot;
    if (!isset($task)) $task="lib";
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $delays=array();
    $cnt=-1;
    $filter="";
    # deal with filter, if any
    if (isset($_SESSION["libdelaysfilter"])) $filter=validfilter($_SESSION["libdelaysfilter"], $libdelaysitems);
    if (!isset($_SESSION["lastlibdelaysfilter"])) $_SESSION["lastlibdelaysfilter"]="";
    # if filter changes, always start at line 0
    if ($_SESSION["libdelaysfilter"] != $_SESSION["lastlibdelaysfilter"]) {
        $_SESSION["libdelaysstart"]=0;
        $_SESSION["lastlibdelaysfilter"]=$_SESSION["libdelaysfilter"];
    }
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        if (strstr($line, "delay_dn=") !== false && strstr($line, "error=") === false && filtermatch($line,$filter,$libdelaysitems)) {
            $cnt++;
            if ($cnt < $_SESSION["libdelaysstart"]) continue;
            $delays[]=$line;
            if ($cnt >= $limit+$_SESSION["libdelaysstart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $delays;
}

function getleakage ($lveroot,$path, $task) {
    global $limit;
    global $leakageitems;
    global $diskroot;
    if (! isset($task)) $task="alint";
    $file="$diskroot/$lveroot/$path/$task.raw";
    if (file_exists($file))
       $fp=fopen ("$file","r");
    else
        $fp=popen("/bin/gunzip -c '$file.gz'", "r");
    $leakage=array();
    $cnt=-1;
    if (isset($_SESSION["leakagefilter"])) $filter=validfilter($_SESSION["leakagefilter"], $leakageitems);
    if (!isset($_SESSION["lastleakagefilter"])) $_SESSION["lastleakagefilter"]="";
    # if filter changes, always start at line 0
    if ($_SESSION["leakagefilter"] != $_SESSION["lastleakagefilter"]) {
        $_SESSION["leakagestart"]=0;
        $_SESSION["lastleakagefilter"]=$_SESSION["leakagefilter"];
    }
    while ($fp !== false and ! feof($fp)) {
        $line=fgets($fp);
        if (strstr($line, "leak_dn=") !== false && strstr($line, "error=") === false && filtermatch($line,$filter,$leakageitems)) {
            $cnt++;
            if ($cnt < $_SESSION["leakagestart"]) continue;
            $leakage[]=$line;
            if ($cnt >= $limit+$_SESSION["leakagestart"]-1) break;
        }
    }
    if (file_exists($file))
        fclose($fp);
    else
        pclose($fp);
    return $leakage;
}

function libdelayheader () {
?>
<tr BGCOLOR="#CCCCFF">
<th>Node</th>
<th>stdout</th>
<th>stderr</th>
<th>CC</th>
<th>Tau (ps)</th>
<th>Slow Delay Dn (ns)</th>
<th>Slow Delay Up (ns)</th>
<th>Slow Slew Dn (ns)</th>
<th>Slow Slew Up (ns)</th>
</tr>
<?php
}

function showlibdelays ($delays, $lveroot, $path, $task) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="lib";
    libdelayheader();
    foreach ($delays as $line) {
        $split=preg_split("/ /",$line);
        $status=array_shift($split);
        $node=substr($split[3], 5);
        $cc=substr($split[4],3);
        $tau=substr($split[5],4);
        $slow_delay_dn=substr($split[12],14);
        $slow_delay_up=substr($split[13],14);
        $slow_slew_dn=substr($split[14],13);
        $slow_slew_up=substr($split[15],13);
        $out="out";
        $err="err";
        $bin=0;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/lib.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/lib.bin.$abin/$node/out\">out</a>";
                $err="<a href=\"/work/$lveroot/$path/lib.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        if (is_file("$diskroot/$lveroot/$path/lib.bin.$bin/$node/slow_dn:$cc:$tau.png")) {
            $slow_delay_dn="<a href=\"/work/$lveroot/$path/lib.bin.$bin/$node/slow_dn:$cc:$tau.png\">$slow_delay_dn</a>";
            $slow_slew_dn="<a href=\"/work/$lveroot/$path/lib.bin.$bin/$node/slow_dn:$cc:$tau.png\">$slow_slew_dn</a>";
        }
        if (is_file("$diskroot/$lveroot/$path/lib.bin.$bin/$node/slow_up:$cc:$tau.png")) {
            $slow_delay_up="<a href=\"/work/$lveroot/$path/lib.bin.$bin/$node/slow_up:$cc:$tau.png\">$slow_delay_up</a>";
            $slow_slew_up="<a href=\"/work/$lveroot/$path/lib.bin.$bin/$node/slow_up:$cc:$tau.png\">$slow_slew_up</a>";
        }
        print "<tr style='background: $color[$status];'><td>$node<td>$out<td>$err<td>$cc<td>$tau<td>$slow_delay_dn<td>$slow_delay_up<td>$slow_slew_dn<td>$slow_slew_up\n";
    }
}

function showerrors ($errors, $lveroot, $path,$task) {
    global $limit;
    global $color;
    global $diskroot;
    if (! isset($task)) $task="alint";
    foreach ($errors as $line) {
        $ret=parse_raw_line($line);
        $status=$ret["status"];
        $node=$ret["node"];
        $delay_dn=$ret["delay_dn"];
        $delay_up=$ret["delay_up"];
        $error=$ret["error"];
        $out="out";
        $err="err";
        $bin=0;
        foreach (array(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15) as $abin) {
            if (is_file("$diskroot/$lveroot/$path/$task.bin.$abin/$node/out")) {
                $out="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/out\">out</a>";
                $err="<a href=\"/work/$lveroot/$path/$task.bin.$abin/$node/err\">err</a>";
                $bin=$abin;
                break;
            }
        }
        print "<tr style='background: $color[$status];'><td>$node<td>$out<td>$err<td>$delay_dn<td>$delay_up<td>$error\n";
    }
}

function parse_raw_line ($line) {
    $parsed=preg_split("/ /", $line, 5);
    $ret=array();
    $ret["status"]=$parsed[0];
    if (isset($parsed[4])) {
        $args=preg_split("/ /", $parsed[4]);
        $parsed[4]=array();
        foreach ($args as $value) {
            if (preg_match("/=/", $value)) {
                list($n,$v)=preg_split("/=/", $value, 2);
                $ret[$n]=$v;
            }
            else {
                $ret[$value]="";
            }
        }
    }
    return $ret;
}

function getfiles () {
    global $lveroot;
    global $path;
    global $scripttask;
    global $diskroot;
    $diag=array();
    if (is_dir("$diskroot/$lveroot/$path")) {
        $dir=opendir("$diskroot/$lveroot/$path");
        while ($dir and ($file = readdir($dir)) !== false) {
            if (is_file("$diskroot/$lveroot/$path/$file") and filesize("$diskroot/$lveroot/$path/$file") > 0) {
                if ( preg_match("/\.$scripttask/", $file) or substr($file,0,strlen($scripttask)+1)=== "$scripttask.") {
                    if (preg_match(":\.diag$:", $file)) {
                        $diag[]=$file;
                    }
                    elseif (! preg_match(":\.(html|trace)$:", $file)) {
                        if (preg_match(":\.gz$:", $file))
                            echo "<LI><a href=\"unzip.php?file=$diskroot/$lveroot/$path/$file\">$file</a><br>";
                        else
                            echo "<LI><a href=\"/work/$lveroot/$path/$file\">$file</a><br>";
                    }
                }
                elseif ($scripttask == "extract" and $file == "graybox_list") {
                    echo "<LI><a href=\"/work/$lveroot/$path/$file\">$file</a><br>";
                }
            }
        }
        closedir($dir);
    }
    return($diag);
}

function dbquery($query) {
    global $dbprefix;
    global $db;
    if ($dbprefix === "")
        return $db->query($query);
    $sth=$db->prepare($query);
    $sth->execute();
    return $sth;
}

function dbfetchrow($data) {
    global $dbprefix;
    global $db;
    if ($dbprefix === "")
        return $data->fetchArray();
    return $data->fetch(PDO::FETCH_ASSOC);
}

function quicklink() {
    global $sqllitepath;
    $skip=array(
        "MYSAPSSO2", "PHPSESSID","quick",
    );
    $quick=array();
    foreach ($_REQUEST as $key => $value) {
        if (! in_array($key,$skip)) {
            $v = str_replace("%","%".sprintf("%02x", ord("%")), $value);
            $v = str_replace(",","%".sprintf("%02x", ord(",")), $v);
            $v = str_replace(";","%".sprintf("%02x", ord(";")), $v);
            $v = str_replace("=","%".sprintf("%02x", ord("=")), $v);
            $v = str_replace(":","%".sprintf("%02x", ord(":")), $v);
            $quick[$key]="$key:$v";
        }
    }
    foreach ($_SESSION as $key => $value) {
        if (! in_array($key,$skip) && strlen($key) <= 28) {
            $v = str_replace("%","%".sprintf("%02x", ord("%")), $value);
            $v = str_replace(",","%".sprintf("%02x", ord(",")), $v);
            $v = str_replace(";","%".sprintf("%02x", ord(";")), $v);
            $v = str_replace("=","%".sprintf("%02x", ord("=")), $v);
            $v = str_replace(":","%".sprintf("%02x", ord(":")), $v);
            $quick[$key]="$key=$v";
        }
    }
    sort($quick);
    $q=join(",",$quick);
    $md5=md5($q);
    $_SESSION[$md5]=$q;
    $qdb=new SQLite3("$sqllitepath");
    $success=0;
    if ($qdb) {
        $r=$qdb->query("select md5 from quick where md5=\"$md5\"");
        $x=$r->fetchArray();
        if (isset($x[0])) {
            $query="update quick set value=\"$q\" where md5=\"$md5\"";
            $r=$qdb->query($query);
            if ($r) $success=1;
#            if ($r) print "update succeeded<br>";
#            else print "Failed to update md5 $query<br>";
        }
        else {
            $query = "insert into quick ( md5 , value ) values ( \"$md5\", \"$q\" )";
            $r=$qdb->query($query);
            if ($r) $success=1;
#            if ($r) print "insert succeeded<br>";
#            else print "Failed to insert md5 $query<br>";
        }
        $qdb->close();
    }
#    else {
#        print "Failed to open md5 db<br>";
#    }
    if ($success) print ("<a href=\"$_SERVER[REQUEST_URI]?quick=$md5\">Quick Link to this page</a><br>");
}

function parse_restore($string) {
    $split=preg_split("/,/", $string);
    foreach ($split as $value) {
        if (strstr($value, ":")) {
            $v=preg_split("/:/", $value);
            $v[1] = str_replace("%".sprintf("%02x", ord(":")),":", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord("=")),"=", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord(";")),";", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord(",")),",", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord("%")),"%", $v[1]);
            $_REQUEST[$v[0]]=$v[1];
        }
        if (strstr($value, "=")) {
            $v=preg_split("/=/", $value);
            if (strlen($v[0]) == 32) next;
            $v[1] = str_replace("%".sprintf("%02x", ord(":")),":", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord("=")),"=", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord(";")),";", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord(",")),",", $v[1]);
            $v[1] = str_replace("%".sprintf("%02x", ord("%")),"%", $v[1]);
            $_SESSION[$v[0]]=$v[1];
        }
    }
}

function restore_quick() {
    if (isset($_GET["quick"])) {
        $md5=$_GET["quick"];
        $qdb=new SQLite3("/scratch/quick.sqlite");
        if ($qdb) {
            $r=$qdb->query("select value from quick where md5=\"$md5\"");
            $x=$r->fetchArray();
            if ($x and isset($x["value"])) parse_restore($x["value"]);
            else print "In valid quick link<br>";
            $qdb->close();
        }
    }
}

?>
