// Autogenerated Jamon implementation
// C:/Users/mhesseli/Documents/Perforce/rrc-4/reg-main/shared/java/src/./com/fulcrummicro/hw/verification/chip/mgmt/registers/templates/CastMgmtTcam.jamon

package com.fulcrummicro.hw.verification.chip.mgmt.registers.templates;

// 6, 1
import java.util.Collection;
// 7, 1
import com.fulcrummicro.util.misc.Utility;
// 8, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.*;

public class CastMgmtTcamImpl
  extends org.jamon.AbstractTemplateImpl
  implements com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam.Intf

{
  private final RegisterBase base;
  private final Collection<Register> registers;
  private final String baseNamePrefixCC;
  protected static com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam.ImplData __jamon_setOptionalArguments(com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam.ImplData p_implData)
  {
    return p_implData;
  }
  public CastMgmtTcamImpl(org.jamon.TemplateManager p_templateManager, com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam.ImplData p_implData)
  {
    super(p_templateManager, __jamon_setOptionalArguments(p_implData));
    base = p_implData.getBase();
    registers = p_implData.getRegisters();
    baseNamePrefixCC = p_implData.getBaseNamePrefixCC();
  }
  
  @Override public void renderNoFlush(final java.io.Writer jamonWriter)
    throws java.io.IOException
  {
    // 16, 1
    for (Register reg : registers )
    {
      // 17, 14
      if (reg.getName().matches(".*_CAM\\d*") || ((reg.getImplementation().get("type") != null) && reg.getImplementation().get("type").equals("TCAM")) )
      {
        // 18, 1
        String regName = reg.getName(); 
        // 19, 1
        String structName = regName + "_KEYS"; 
        // 20, 1
        RegisterStruct struct = base.getStruct(structName); 
        // 21, 1
        //compute whether the TCAM is banked, by comparing key width vs tcam width
RegisterField keyField = reg.getField("Key");
int numDimensions = reg.getNumDimensions(); assert(numDimensions<4);
if (keyField == null) System.err.println("tcam missing Key field: "+reg.getName());
int tcamKeyWidth = keyField.len;
boolean tcamHasBanks = false;
String structNameCC = "";
int tcamTotalBankWidth = tcamKeyWidth;
int tcamNumBanks = 1;
int tcamKeyStructWidth = -1;
if (struct != null) {
    structNameCC = Utility.underscoreToCamelCase(structName, true);
	tcamKeyStructWidth = struct.getBitWidth();
	tcamHasBanks = tcamKeyStructWidth > tcamKeyWidth;
} else {
	tcamHasBanks = numDimensions > 1;
}
if (tcamHasBanks) {
	tcamNumBanks = reg.getNumEntries();
}
tcamTotalBankWidth = tcamKeyWidth * tcamNumBanks;
//check bank width
	if (struct!=null && tcamHasBanks) {
		if (tcamTotalBankWidth < tcamKeyStructWidth)
			System.err.println("ERROR: "+regName+" total bank width ("+tcamTotalBankWidth+") is less than key width ("+tcamKeyStructWidth+")");
	}

        // 49, 97
        jamonWriter.write("    //TCAM lookup function ");
        // 50, 28
        if (struct != null )
        {
          // 50, 50
          jamonWriter.write("supporting struct ");
          // 50, 68
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(struct.getName()), jamonWriter);
        }
        // 50, 96
        jamonWriter.write("\n");
        // 51, 1
        String tcamNameCC = Utility.underscoreToCamelCase(regName, true); 
        // 52, 1
        String baseNameCC = baseNamePrefixCC + "Registers"; 
        // 52, 62
        jamonWriter.write("    function lookup");
        // 53, 20
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamNameCC), jamonWriter);
        // 53, 36
        jamonWriter.write(" (\n");
        // 54, 1
        if (struct == null )
        {
          // 54, 23
          jamonWriter.write("      int                                      -input_key;  //key for lookup\n");
        }
        // 56, 1
        else
        {
          // 56, 8
          jamonWriter.write("      ");
          // 57, 7
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("%-40s",structNameCC)), jamonWriter);
          // 57, 48
          jamonWriter.write(" -k;         //key struct for lookup\n");
        }
        // 58, 7
        jamonWriter.write("      ");
        // 59, 7
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(String.format("%-40s",baseNameCC)), jamonWriter);
        // 59, 46
        jamonWriter.write(" -s;         //register state for tcam\n      int                                      -slice_num; //for lookup\n      int                                      +raw_hit;   //indices with hits\n      int                                      +hit_index; //highest hit\n      ) = (\n\n      //DEBUG: tcamKeyWidth=");
        // 65, 29
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 65, 47
        jamonWriter.write("\n      //DEBUG: tcamTotalBankWidth=");
        // 66, 35
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 66, 59
        jamonWriter.write("\n      //DEBUG: tcamNumBanks=");
        // 67, 29
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamNumBanks), jamonWriter);
        // 67, 47
        jamonWriter.write("\n      //DEBUG: tcamKeyStructWidth=");
        // 68, 35
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyStructWidth), jamonWriter);
        // 68, 59
        jamonWriter.write("\n      int W_KEY    = ");
        // 69, 22
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(regName), jamonWriter);
        // 69, 35
        jamonWriter.write("_w_Key; //width of key in single bank of tcam\n      int(");
        // 70, 11
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 70, 29
        jamonWriter.write(") KEY_MASK = 2**W_KEY-1;\n");
        // 71, 1
        String[] entryNames = new String[3];
String arraySelectStrings[] = new String[3];
String dimensionIndexStrings[] = new String[3];
for (int i=0; i<3; i++) {
	entryNames[i] = "1";
	arraySelectStrings[i] = "";
	}
dimensionIndexStrings[0]="[bank]";
dimensionIndexStrings[1]="[index]";
dimensionIndexStrings[2]="[slice_num]";
int i=0;
int e=0;
//if only 1 dim, the constant is _ENTRIES
if (tcamHasBanks) {
	if (numDimensions==1 && e==0) {
		entryNames[i] = regName +"_ENTRIES";
	} else {
		entryNames[i] = regName +"_ENTRIES_"+e;
		}
	arraySelectStrings[i] = dimensionIndexStrings[i];
	e++;
	}
i++;
for (; e<numDimensions; e++) {
	if (numDimensions==1 && e==0) {
		entryNames[i] = regName + "_ENTRIES";
	} else {
		entryNames[i] = regName +"_ENTRIES_"+e;
	}
	arraySelectStrings[i] = dimensionIndexStrings[i];
	i++;
	}

        // 105, 1
        if (numDimensions >= 4 )
        {
          // 105, 27
          jamonWriter.write("  // ERROR dimensions >= 4 not supported\n  assert(0,\"could not generate code\");\n");
        }
        // 108, 1
        else
        {
          // 108, 8
          jamonWriter.write("      int N_BANKS  = ");
          // 109, 22
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(entryNames[0]), jamonWriter);
          // 109, 41
          jamonWriter.write(";\n      int N_RULES  = ");
          // 110, 22
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(entryNames[1]), jamonWriter);
          // 110, 41
          jamonWriter.write(";\n      int N_SLICES = ");
          // 111, 22
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(entryNames[2]), jamonWriter);
          // 111, 41
          jamonWriter.write(";\n");
        }
        // 112, 33
        jamonWriter.write("\n");
        // 114, 1
        if (struct != null )
        {
          // 114, 23
          jamonWriter.write("      //pack input structure into int for lookup\n      int(");
          // 116, 11
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
          // 116, 35
          jamonWriter.write(") input_key = pack(k);\n");
        }
        // 117, 7
        jamonWriter.write("\n      hit_index   = 0;\n      raw_hit     = 0;\n\n      //search each rule\n      int index = 0; //index into a rule of the tcam\n      *[ index < N_RULES ->\n        int(");
        // 125, 13
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 125, 37
        jamonWriter.write(") zero_vec = 0;\n        int(");
        // 126, 13
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 126, 37
        jamonWriter.write(") ones_vec = 0;\n        //if any bits have (~Key & ~KeyInvert) short circuit TCAM lookup\n        bool entry_invalid = false;\n        //aggregate individual TCAM banks into key invert\n        int bank = 0;\n        *[~entry_invalid & (bank < N_BANKS)->\n");
        // 132, 1
        String tcamCSPStructName = Utility.underscoreToCamelCase(regName, true);
String tcamCSPStructFieldName = regName.toLowerCase();

        // 135, 3
        jamonWriter.write("          ");
        // 136, 11
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamCSPStructName), jamonWriter);
        // 136, 34
        jamonWriter.write(" tcam_entry = s::");
        // 136, 51
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamCSPStructFieldName), jamonWriter);
        // 137, 1
        for (int a=2; a>=0; a-- )
        {
          // 138, 1
          org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(arraySelectStrings[a]), jamonWriter);
        }
        // 139, 8
        jamonWriter.write(";\n          int(");
        // 140, 15
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 140, 33
        jamonWriter.write(") key          = tcam_entry::Key;\n          int(");
        // 141, 15
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 141, 33
        jamonWriter.write(") key_invert   = tcam_entry::KeyInvert;\n          //simulation speedup by checking that entry is active\n          entry_invalid = key{0}==0 & key_invert{0}==0;\n          //if entry is active then perform key matching\n          #[ ~entry_invalid ->\n            int(");
        // 146, 17
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 146, 35
        jamonWriter.write(") cleared_bits = ~key & ~key_invert & KEY_MASK;\n            entry_invalid = cleared_bits != 0;\n            zero_vec = zero_vec | ( key_invert << (");
        // 148, 52
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 148, 70
        jamonWriter.write(" * bank));\n            ones_vec = ones_vec | ( key        << (");
        // 149, 52
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 149, 70
        jamonWriter.write(" * bank));\n          ];\n          bank++;\n        ];\n\n        #[~entry_invalid -> // compute raw hit and hit index\n          int(");
        // 155, 15
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 155, 39
        jamonWriter.write(") WIDE_KEY_MASK = 2**(N_BANKS*");
        // 155, 69
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamKeyWidth), jamonWriter);
        // 155, 87
        jamonWriter.write(") -1;\n          int(");
        // 156, 15
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 156, 39
        jamonWriter.write(") unexp_one_mask  = ( input_key & ~ones_vec & WIDE_KEY_MASK);\n          int(");
        // 157, 15
        org.jamon.escaping.Escaping.HTML.write(org.jamon.emit.StandardEmitter.valueOf(tcamTotalBankWidth), jamonWriter);
        // 157, 39
        jamonWriter.write(") unexp_zero_mask = (~input_key & ~zero_vec & WIDE_KEY_MASK);\n          bool hit = (unexp_one_mask==0) & (unexp_zero_mask==0);\n          #[ hit ->\n            raw_hit{index}=1;\n            hit_index=index;\n          ];\n        ];\n        index++\n      ]\n    );\n");
      }
    }
    // 168, 24
    jamonWriter.write("\n\n");
  }
  
  
}
