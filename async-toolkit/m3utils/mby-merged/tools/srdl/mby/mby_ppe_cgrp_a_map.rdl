`include "lib_udp.rdl"
<% use security; %>
<% my %Security_Props = security::GetSecurityInfo(); %>

`include "mby_ppe_cgrp_em_map.rdl"

reg lpm_key_sel0_r {
  shared;
  HandCoded = true;
  name = "Key select for LPM";
  desc = "
        Selects the bytes of key for the LPM lookup.  Indexed by profile ID.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY16 fields to use for the metadata portion of the LPM key.
           ";
    ValRandomize = true;
  } MD_KEY16_SEL[63:0] = 64'h0;
};

reg lpm_key_sel1_r {
  shared;
  HandCoded = true;
  name = "Key select for LPM";
  desc = "
        Selects the bytes of key for the LPM lookup.  Indexed by profile ID.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY8 fields to use for the address portion of the LPM key.
           ";
    ValRandomize = true;
  } ADDR_KEY8_SEL[63:32] = 32'h0;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY8 fields to use for the metadata portion of the LPM key.
           ";
    ValRandomize = true;
  } MD_KEY8_SEL[31:0] = 32'h0;
};

reg lpm_key_sel2_r {
  shared;
  HandCoded = true;
  name = "Key select for LPM";
  desc = "
        Selects the bytes of key for the LPM lookup.  Indexed by profile ID.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY16 fields to use for the address portion of the LPM key.
           ";
    ValRandomize = true;
  } ADDR_KEY16_SEL[63:0] = 64'h0;
};

reg lpm_key_sel3_r {
  shared;
  HandCoded = true;
  name = "Key select for LPM";
  desc = "
        Selects the bytes of key for the LPM lookup.  Indexed by profile ID.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY32 fields to use for the address portion of the LPM key.
           ";
    ValRandomize = true;
  } ADDR_KEY32_SEL[15:0] = 16'h0;
};

reg lpm_key_mask_r {
  shared;
  HandCoded = true;
  name = "Key mask for LPM";
  desc = "
        Configures the 160b mask used against the LPM key for lookup.  This
        register is indexed first by profile.  The second index j selects
        the j'th 64b chunk of the mask.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Selects which of the KEY16 fields to use for the metadata portion of the LPM key.
           ";
    ValRandomize = true;
  } MASK[63:0] = 64'h0;
};
regfile lpm_key_mask_rf {
  lpm_key_mask_r LPM_KEY_MASK[20] += 8;
};

reg lpm_match_tcam_r {
  shared;
  HandCoded = true;
  name = "Pre-lookup for LPM search";
  desc = "
            Matches the first 4B of the key, the 'metadata' portion.  This
            field can be up to 4B.  Each entry of LPM_MATCH_TCAM points into
            a root subtrie to search into.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    The inverted key value to match against.
           ";
    ValRandomize = true;
  } KEY_INVERT[63:32] = 32'h0;
  field {
    AccessType = "RW";
    desc = "
    The key value to match against.
           ";
    ValRandomize = true;
  } KEY[31:0] = 32'h0;
};

reg lpm_match_action_r {
  shared;
  HandCoded = true;
  name = "Pre-lookup for LPM search";
  desc = "
            Action results for the TCAM match in LPM_MATCH_TCAM.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
        The number of child pointers at the list starting at CHILD_BASE_PTR.
           ";
    ValRandomize = true;
  } CHILD_PTR_LEN[39:32] = 8'h0;
  field {
    AccessType = "RW";
    desc = "
    An index into LPM_SUBTRIE_CPTR selecting the child pointer list associated with the
    subtrie in ROOT_PTR.
           ";
    ValRandomize = true;
  } CHILD_BASE_PTR[31:16] = 16'h0;
  field {
    AccessType = "RW";
    desc = "
    An index into LPM_SUBTRIE_{BITMAPS,APTR} selecting the root subtrie to search into.
           ";
    ValRandomize = true;
  } ROOT_PTR[15:0] = 16'h0;
};

reg lpm_subtrie_bitmaps_r {
  shared;
  HandCoded = true;
  name = "Sub-trie storage for LPM";
  desc = "
            Contains the prefix and child presence bitmaps for each subtrie.
            This register is indexed first by subtrie number, and then by
            columns 0..7, representing the 255b of prefix bitmap (columns 0..3) and 256b of
            child presence bitmap (columns 4..7).
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Bit map array as described.
           ";
    ValRandomize = true;
  } BITMAP[63:0] = 64'h0;
};
regfile lpm_subtrie_bitmaps_rf {
  lpm_subtrie_bitmaps_r LPM_SUBTRIE_BITMAPS[8] += 8;
};

reg lpm_subtrie_cptr_r {
  shared;
  HandCoded = true;
  name = "Sub-trie storage for LPM";
  desc = "
            Contains the list of child pointers associated with the given subtrie
            as well as the new CHILD_BASE_PTR for each of those child subtries.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
    Length of the child pointer list at CHILD_BASE_PTR.
           ";
    ValRandomize = true;
  } CHILD_PTR_LEN[39:32] = 8'h0;
  field {
    AccessType = "RW";
    desc = "
    Pointer into LPM_SUBTRIE_CPTR for this child.
           ";
    ValRandomize = true;
  } CHILD_BASE_PTR[31:16] = 16'h0;
  field {
    AccessType = "RW";
    desc = "
    Pointer into LPM_SUBTRIE_BITMAPS for this child.
           ";
    ValRandomize = true;
  } SUBTRIE_PTR[15:0] = 16'h0;
};

reg lpm_subtrie_aptr_r {
  shared;
  HandCoded = true;
  name = "Sub-trie storage for LPM";
  desc = "
            Contains the ACTION_BASE_PTR for each subtrie.  This references a
            pointer into SHM_FWD_TABLE0.
           ";
  Security_PolicyGroup = <%=$Security_Props{'MBY_PG1'}%>;
  Security_ReadAccess_Str = <%=$Security_Props{'MBY_PG1_RAC_AGENTS'}%>;
  Security_WriteAccess_Str = <%=$Security_Props{'MBY_PG1_WAC_AGENTS'}%>;
  regwidth = 64;
  accesswidth = 64;
  field {
    AccessType = "RW";
    desc = "
            Indicates the base pointer for the actions for this subtrie.  This value is
            in 16B units and indicates the address into SHM_FWD_TABLE0.
           ";
    ValRandomize = true;
  } ACTION_BASE_PTR[18:0] = 19'h0;
};

addrmap mby_ppe_cgrp_a_nested_map {
  name = "mby_nested_a";
  desc = "Classifier group A registers";
  Space = "MSG";
  Opcode = "MEM-SB";
  No_IOSF_Primary = true;
  addressing = fullalign;

  em_hash_lookup_r            EM_HASH_LOOKUP[32768]; // 32k

  lpm_subtrie_aptr_r          LPM_SUBTRIE_APTR[24576];
  lpm_subtrie_cptr_r          LPM_SUBTRIE_CPTR[24576];
  lpm_subtrie_bitmaps_rf      LPM_SUBTRIE_BITMAPS[24576];
  lpm_match_tcam_r            LPM_MATCH_TCAM[512];
  lpm_match_action_r          LPM_MATCH_ACTION[512];
  lpm_key_mask_rf             LPM_KEY_MASK[64];
  lpm_key_sel0_r              LPM_KEY_SEL0[64];
  lpm_key_sel1_r              LPM_KEY_SEL1[64];
  lpm_key_sel2_r              LPM_KEY_SEL2[64];
  lpm_key_sel3_r              LPM_KEY_SEL3[64];
};

addrmap mby_ppe_cgrp_a_map {
  name = "mby_em";
  desc = "Classifier group A registers";
  Space = "MSG";
  Opcode = "MEM-SB";
  No_IOSF_Primary = true;
  addressing = fullalign;

  mby_ppe_cgrp_em_map         EM;
  mby_ppe_cgrp_a_nested_map   A;
}; // final size: 0x22600 <= 0x40000 = 8<<15
