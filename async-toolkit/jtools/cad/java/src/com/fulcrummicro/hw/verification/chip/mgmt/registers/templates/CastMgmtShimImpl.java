// Autogenerated Jamon implementation
// C:/Users/mhesseli/Documents/Perforce/rrc-4/reg-main/shared/java/src/./com/fulcrummicro/hw/verification/chip/mgmt/registers/templates/CastMgmtShim.jamon

package com.fulcrummicro.hw.verification.chip.mgmt.registers.templates;

// 4, 1
import java.util.Collection;
// 5, 1
import com.fulcrummicro.util.misc.Utility;
// 6, 1
import com.fulcrummicro.hw.verification.chip.mgmt.registers.*;

public class CastMgmtShimImpl
  extends com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastCommonImpl
  implements com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtShim.Intf

{
  private final Collection<RegisterCrossbarPort> crossbarPorts;
  private final String chip;
  protected static com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtShim.ImplData __jamon_setOptionalArguments(com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtShim.ImplData p_implData)
  {
    com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastCommonImpl.__jamon_setOptionalArguments(p_implData);
    return p_implData;
  }
  public CastMgmtShimImpl(org.jamon.TemplateManager p_templateManager, com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtShim.ImplData p_implData)
  {
    super(p_templateManager, __jamon_setOptionalArguments(p_implData));
    crossbarPorts = p_implData.getCrossbarPorts();
    chip = p_implData.getChip();
  }
  
  @Override protected void child_render_2(final java.io.Writer jamonWriter)
    throws java.io.IOException
  {
    // 11, 9
    jamonWriter.write("module chip.");
    // 12, 13
    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
    // 12, 23
    jamonWriter.write(".base.register_mgmt_shim;\n\nimport chip.");
    // 14, 13
    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
    // 14, 23
    jamonWriter.write(".mgmt.channel.TargetInternalMgmtInterface;\n\n");
    // 16, 1
    for (RegisterCrossbarPort xbPort : crossbarPorts )
    {
      // 17, 1
      if (!xbPort.hasBusStops() )
      {
        // 17, 30
        jamonWriter.write("define ");
        // 19, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName()), jamonWriter);
        // 19, 30
        jamonWriter.write("_RegisterHandling (int N_D)(TargetInternalMgmtInterface(\n       ");
        // 20, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 20, 50
        jamonWriter.write("                              ");
        // 20, 80
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getNumRegisters()), jamonWriter);
        // 20, 110
        jamonWriter.write(" /*=N_REG*/,\n       ");
        // 21, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 21, 50
        jamonWriter.write("                              ");
        // 21, 80
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntriesAtomic()), jamonWriter);
        // 21, 114
        jamonWriter.write(" /*=MAX_ENTRIES_A*/,\n       ");
        // 22, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 22, 50
        jamonWriter.write("                              ");
        // 22, 80
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(0)), jamonWriter);
        // 22, 109
        jamonWriter.write(" /*=MAX_ENTRIES_0*/,\n       ");
        // 23, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 23, 50
        jamonWriter.write("                              ");
        // 23, 80
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(1)), jamonWriter);
        // 23, 109
        jamonWriter.write(" /*=MAX_ENTRIES_1*/,\n       ");
        // 24, 8
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 24, 50
        jamonWriter.write("                              ");
        // 24, 80
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(2)), jamonWriter);
        // 24, 109
        jamonWriter.write(" /*=MAX_ENTRIES_2*/,\n        ");
        // 25, 9
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName().replaceAll("."," ")), jamonWriter);
        // 25, 51
        jamonWriter.write("                             N_D) +M) attributes\n  <+ chip.");
        // 26, 11
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
        // 26, 21
        jamonWriter.write(".mgmt.base.MgmtIfCell\n  <+ chip.");
        // 27, 11
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
        // 27, 21
        jamonWriter.write(".mgmt.crossbar.shim.impl.");
        // 27, 46
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getName()), jamonWriter);
        // 27, 68
        jamonWriter.write("_RegisterEnumeration\n");
        // 28, 1
        for (RegisterBase base : xbPort.getRegisterBases() )
        {
          // 29, 1
          String camelCaseBaseName = Utility.underscoreToCamelCase(base.getName(), true); 
          // 29, 90
          jamonWriter.write("  <+ chip.");
          // 30, 11
          org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
          // 30, 21
          jamonWriter.write(".base.registers.");
          // 30, 37
          org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCaseBaseName), jamonWriter);
          // 30, 60
          jamonWriter.write("RegisterFields\n");
        }
        // 31, 8
        jamonWriter.write("  <+ chip.");
        // 32, 11
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
        // 32, 21
        jamonWriter.write(".base.registers.AddressSpace\n  <+ chip.");
        // 33, 11
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(chip), jamonWriter);
        // 33, 21
        jamonWriter.write(".base.functions.RegisterFunctions\n  <+ functions {\n\n  int W_IDX_R = max(1,log2(");
        // 36, 28
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getNumRegisters()), jamonWriter);
        // 36, 58
        jamonWriter.write("));\n  int W_IDX_A = max(1,log2(");
        // 37, 28
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntriesAtomic()), jamonWriter);
        // 37, 62
        jamonWriter.write("));\n  int W_IDX_0 = max(1,log2(");
        // 38, 28
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(0)), jamonWriter);
        // 38, 57
        jamonWriter.write("));\n  int W_IDX_1 = max(1,log2(");
        // 39, 28
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(1)), jamonWriter);
        // 39, 57
        jamonWriter.write("));\n  int W_IDX_2 = max(1,log2(");
        // 40, 28
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(xbPort.getMaxEntries(2)), jamonWriter);
        // 40, 57
        jamonWriter.write("));\n\n  csp {\n\n");
        // 44, 1
        String camelCasePortName = Utility.underscoreToCamelCase(xbPort.getName(), true); 
        // 44, 92
        jamonWriter.write("    structure ");
        // 45, 15
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 45, 38
        jamonWriter.write("Mgmt = (\n        int(1) rw;\n        int(W_IDX_R) idx_r;\n        int(W_IDX_A) idx_a;\n        int(W_IDX_0) idx_0;\n        int(W_IDX_1) idx_1;\n        int(W_IDX_2) idx_2;\n        int(N_D*32)  data\n    );\n\n    function receive");
        // 55, 21
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 55, 44
        jamonWriter.write("Mgmt()\n      : int(1+W_IDX_R+W_IDX_A+W_IDX_0+W_IDX_1+W_IDX_2+N_D*32) = (\n      ");
        // 57, 7
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 57, 30
        jamonWriter.write("Mgmt m;\n      M.RW?     m::rw,\n      M.IDX_R?  m::idx_r,\n      M.IDX_A?  m::idx_a,\n      M.IDX_0?  m::idx_0,\n      M.IDX_1?  m::idx_1,\n      M.IDX_2?  m::idx_2;\n      #[m::rw==1 ->\n        M.WD?   m::data\n       ];\n      receive");
        // 67, 14
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 67, 37
        jamonWriter.write("Mgmt = pack(m)\n    );\n\n    function send");
        // 70, 18
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 70, 41
        jamonWriter.write("Mgmt(");
        // 70, 46
        org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
        // 70, 69
        jamonWriter.write("Mgmt -mgmt) = (\n      #[mgmt::rw==0 -> M.RD!mgmt::data]\n    );\n");
        // 73, 1
        for (RegisterBase base : xbPort.getRegisterBases() )
        {
          // 74, 1
          String camelCaseBaseName = Utility.underscoreToCamelCase(base.getName(), true); 
          // 75, 1
          for (String group : base.getGroups() )
          {
            // 76, 1
            
String camelCaseGroupName = base.getName();
if (group != null) camelCaseGroupName += "_" + group.toUpperCase();
camelCaseGroupName = Utility.underscoreToCamelCase(camelCaseGroupName, true);
Collection<Register> groupRegisters = base.getRegisters("group", group);

            // 81, 9
            jamonWriter.write("\n");
            // 84, 1
            {
              // 84, 1
              __jamon_innerUnit__registerStructureBase(jamonWriter, groupRegisters, camelCaseGroupName );
            }
            // 84, 92
            jamonWriter.write("\n");
            // 85, 1
            if (group==null )
            {
              // 85, 20
              for (String g : base.getGroups() )
              {
                // 85, 56
                if (g != null )
                {
                  // 85, 73
                  jamonWriter.write("      ");
                  // 86, 7
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(Utility.underscoreToCamelCase(base.getName() + "_" + g.toUpperCase(), true)), jamonWriter);
                  // 86, 88
                  jamonWriter.write("Registers ");
                  // 86, 98
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(g.toLowerCase()), jamonWriter);
                  // 86, 119
                  jamonWriter.write(";\n");
                }
              }
            }
            // 87, 20
            jamonWriter.write("    );\n");
            // 91, 1
            {
              com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam __jamon__var_0 = new com.fulcrummicro.hw.verification.chip.mgmt.registers.templates.CastMgmtTcam(this.getTemplateManager());
              __jamon__var_0.renderNoFlush(jamonWriter, base, groupRegisters, camelCaseGroupName );
            }
            // 93, 41
            jamonWriter.write("    function rw");
            // 94, 16
            org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCaseGroupName), jamonWriter);
            // 94, 40
            jamonWriter.write("Registers(");
            // 94, 50
            org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCasePortName), jamonWriter);
            // 94, 73
            jamonWriter.write("Mgmt -+mgmt; ");
            // 94, 86
            org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(camelCaseGroupName), jamonWriter);
            // 94, 110
            jamonWriter.write("Registers -+s) = (\n");
            // 95, 1
            if (group==null )
            {
              // 96, 1
              for (String g : base.getGroups() )
              {
                // 96, 37
                if (g != null )
                {
                  // 96, 54
                  jamonWriter.write("      rw");
                  // 97, 9
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(Utility.underscoreToCamelCase(base.getName() + "_" + g.toUpperCase(), true)), jamonWriter);
                  // 97, 90
                  jamonWriter.write("Registers(mgmt, s::");
                  // 97, 109
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(g.toLowerCase()), jamonWriter);
                  // 97, 130
                  jamonWriter.write(");\n");
                }
              }
            }
            // 99, 1
            if (!groupRegisters.isEmpty() )
            {
              // 99, 34
              jamonWriter.write("      #[");
              // 101, 1
              boolean first = true; 
              // 102, 1
              for (Register reg : groupRegisters )
              {
                // 102, 39
                if (reg.getAlias() == null )
                {
                  // 103, 1
                  String index; 
                  // 104, 1
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(first ? "" : "      []"), jamonWriter);
                  // 104, 30
                  first=false; 
                  // 104, 52
                  jamonWriter.write("mgmt::idx_r==");
                  // 105, 14
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 105, 33
                  jamonWriter.write("_NUM &\n");
                  // 106, 1
                  if (reg.getNumEntries() > 1 && reg.getNumEntries()%2 != 0 )
                  {
                    // 106, 62
                    jamonWriter.write("mgmt::idx_0 < ");
                    // 107, 15
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getNumEntries()), jamonWriter);
                    // 107, 40
                    jamonWriter.write(" & ");
                  }
                  // 108, 1
                  if (reg.getNumEntries1() > 1 && reg.getNumEntries1()%2 != 0 )
                  {
                    // 108, 64
                    jamonWriter.write("mgmt::idx_1 < ");
                    // 109, 15
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getNumEntries1()), jamonWriter);
                    // 109, 41
                    jamonWriter.write(" & ");
                  }
                  // 110, 1
                  if (reg.getNumEntries2() > 1 && reg.getNumEntries2()%2 != 0 )
                  {
                    // 110, 64
                    jamonWriter.write("mgmt::idx_2 < ");
                    // 111, 15
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getNumEntries2()), jamonWriter);
                    // 111, 41
                    jamonWriter.write(" & ");
                  }
                  // 111, 50
                  jamonWriter.write(" true ->\n");
                  // 112, 1
                  if (reg.getNumEntries() == 1 )
                  {
                    // 113, 1
                    index = ""; 
                  }
                  // 114, 1
                  else if (reg.getNumEntries1() == 1 )
                  {
                    // 115, 1
                    index = "[mgmt::idx_0 & ((1<<log2("+reg.getNumEntries()+"))-1)]"; 
                  }
                  // 116, 1
                  else if (reg.getNumEntries2() == 1 )
                  {
                    // 117, 1
                    index = "[mgmt::idx_1 & ((1<<log2("+reg.getNumEntries1()+"))-1), mgmt::idx_0 & ((1<<log2("+reg.getNumEntries()+"))-1)]"; 
                  }
                  // 118, 1
                  else
                  {
                    // 119, 1
                    index = "[mgmt::idx_2 & ((1<<log2("+reg.getNumEntries2()+"))-1), mgmt::idx_1 & ((1<<log2("+reg.getNumEntries1()+"))-1), mgmt::idx_0 & ((1<<log2("+reg.getNumEntries()+"))-1)]"; 
                  }
                  // 122, 1
                  if (reg.isStructure() )
                  {
                    // 122, 26
                    jamonWriter.write("          int(");
                    // 123, 15
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getImplementationWidth()), jamonWriter);
                    // 123, 49
                    jamonWriter.write(") reg = pack(s::");
                    // 123, 65
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName().toLowerCase()), jamonWriter);
                    // 123, 98
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(index), jamonWriter);
                    // 123, 109
                    jamonWriter.write(");\n");
                  }
                  // 124, 1
                  else
                  {
                    // 124, 8
                    jamonWriter.write("          int(");
                    // 125, 15
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getImplementationWidth()), jamonWriter);
                    // 125, 49
                    jamonWriter.write(") reg = s::");
                    // 125, 60
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName().toLowerCase()), jamonWriter);
                    // 125, 93
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(index), jamonWriter);
                    // 125, 104
                    jamonWriter.write(";\n");
                  }
                  // 126, 7
                  jamonWriter.write("          [ mgmt::rw==0 ->\n            mgmt::data = reg\n          []else ->\n            <i:");
                  // 130, 16
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getImplementationWidth()), jamonWriter);
                  // 130, 50
                  jamonWriter.write(":(\n              regWriteBit(i,\n                ");
                  // 132, 17
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 132, 36
                  jamonWriter.write("_RW_MASK | ");
                  // 132, 47
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 132, 66
                  jamonWriter.write("_RV_MASK,\n                ");
                  // 133, 17
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 133, 36
                  jamonWriter.write("_RO_MASK,\n                ");
                  // 134, 17
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 134, 36
                  jamonWriter.write("_CW_MASK,\n                ");
                  // 135, 17
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName()), jamonWriter);
                  // 135, 36
                  jamonWriter.write("_CW1_MASK,\n                mgmt::data, reg)\n            )>;\n");
                  // 138, 1
                  if (reg.isStructure() )
                  {
                    // 138, 26
                    jamonWriter.write("            unpack(s::");
                    // 139, 23
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName().toLowerCase()), jamonWriter);
                    // 139, 56
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(index), jamonWriter);
                    // 139, 67
                    jamonWriter.write(", reg);\n");
                  }
                  // 140, 1
                  else
                  {
                    // 140, 8
                    jamonWriter.write("            s::");
                    // 141, 16
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(reg.getName().toLowerCase()), jamonWriter);
                    // 141, 49
                    org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(index), jamonWriter);
                    // 141, 60
                    jamonWriter.write(" = reg;\n");
                  }
                  // 142, 7
                  jamonWriter.write("          ];\n");
                }
              }
              // 144, 14
              jamonWriter.write("      ]\n");
            }
            // 146, 7
            jamonWriter.write("    );\n\n");
            // 150, 1
            {
              // 150, 1
              __jamon_innerUnit__registerInitBase(jamonWriter, groupRegisters, camelCaseGroupName );
            }
            // 151, 1
            if (group == null )
            {
              // 152, 1
              for (String g : base.getGroups() )
              {
                // 152, 37
                if (g != null )
                {
                  // 152, 54
                  jamonWriter.write("      init");
                  // 153, 11
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(Utility.underscoreToCamelCase(base.getName() + "_" + g.toUpperCase(), true)), jamonWriter);
                  // 153, 92
                  jamonWriter.write("Registers(mgmt, s::");
                  // 153, 111
                  org.jamon.escaping.Escaping.NONE.write(org.jamon.emit.StandardEmitter.valueOf(g.toLowerCase()), jamonWriter);
                  // 153, 132
                  jamonWriter.write(");\n");
                }
              }
            }
            // 154, 20
            jamonWriter.write("    );\n");
          }
        }
        // 157, 15
        jamonWriter.write("  }\n}\n\n");
      }
    }
    // 161, 14
    jamonWriter.write("\n\n\n");
  }
  
  
}
