#! /usr/intel/pkgs/perl/5.14.1/bin/perl
use strict;
use warnings;
use Getopt::Long;

my $modelRoot = ''; 
my $prefix = '';
my $checker_mode = '';
my $enable_git_mv = '';

my $help_text = <<"HELP_TEXT";
UniquifyMe is a generic script for (re)uniquifying your IP.
It is invoked by Zircon to verify (re)uniquification for SoC Integration.

    -model_root \$MODEL_ROOT (required)  valid path to IP ROOT
    -prefix 'your_prefix' (required)    prefix to uniquify your IP
    -checker_mode (optional)            runs PUNI to uniquify IP, but only reports non-unique files/entities (PUNI makes no changes)
    -enable_git_mv (optional)           PUNI changes files, but does not add them (or delete originals), and generates gitmv_command.list:
                                            > source tools/uniquification/outputs/gitmv_command.list
                                        Run to move files and retain history after PUNI runs, then commit changes
HELP_TEXT

GetOptions(
    'model_root=s' => \$modelRoot,
    'prefix=s' => \$prefix,
    'checker_mode' => sub { $checker_mode = '-checker_mode' },
    'enable_git_mv' => sub { $enable_git_mv = '-enable_git_mv' },
    'help' => sub { print STDOUT $help_text; exit 0; }, 
);

if(!-e $modelRoot) {
    print "-E- Must specify a valid IP_ROOT path with -model_root\n";
    exit 1;
}
if (!defined $prefix) {
    print "-E- Must specify a valid prefix with -prefix\n";
    exit 2;
}
if ($checker_mode ne "-checker_mode") {
    print "-W- Not running in checker_mode.\n";
} 

if ($checker_mode ne "-checker_mode" && $enable_git_mv eq '-enable_git_mv') {
    print "-W- Passing -enable_git_mv with -checker_mode enabled does nothing.\n";
    $enable_git_mv = '';
}


print "-I- Uniquifying $modelRoot with prefix $prefix\n";
#`cd $modelRoot`;
my $error = 0;
## First run uniquification of subIPs
if ( -e "$modelRoot/subIP" ) {
    my $subIPdir = "$modelRoot/subIP/";
    opendir(SRCDIR, $subIPdir);
    my @files = grep { !/^\.{1,2}$/ } readdir (SRCDIR);
    close(SRCDIR);
    print "-I- Found $modelRoot/subIP, recursing\n";
    foreach my $subip (@files) {
        $subip = "$subIPdir/$subip";
        if (!-d $subip) { next;}        
	    if ( -f "$subip/tools/uniquification/scripts/uniquifyme" ) {
	        my $status = system("$subip/tools/uniquification/scripts/uniquifyme $subip $prefix $checker_mode");
	        if ( $status ) {
    	    	$error = 1;
	        }
	    } else {
	        print "-W- Did not find $subip/tools/uniquification/scripts/uniquifyme\n";
	    }
    }
}

## 'fuse' model is not to be uniquified (provided by integrating IP)
#my $cmdPrefix = "find ${modelRoot}/verif/ -type f";
#my $cmdSuffix = ' \( -name \\*.sv -or -name \\*.v \) -not -path \\*/fuse/\\*';
#my $cmd = "${cmdPrefix}${cmdSuffix}";
#my $verilogs = `$cmd`;
my $verilogs = "";
print "verilogs == $verilogs\n";

## Add RTL to RTL Filelist
my $rtlExt = "-name '*.sv' -or -name '*.v' -or -name '*.vh'";
$verilogs   .= `find ${modelRoot}/src/rtl/ -type f $rtlExt`;
#$verilogs   .= `find ${modelRoot}/src/sva/ -type f -name '*.sv' -or -name '*.v' ! -name '*_include*'`;

## Add subIP RTL to RTL Filelist for subIPs without UniquifyMe
#$verilogs   .= `find ${modelRoot}/subIP/common/ -type f $rtlExt`;

my $filelist = "${modelRoot}/tools/uniquification/inputs/$ENV{CLUSTER}.rtl.filelist.autogenerated.txt";
print "Verilogs identified. Saving to $filelist\n";
open(my $fh, '>', $filelist) or die "Could not open file '$filelist' $!";
print $fh $verilogs;
close $fh;
my $cmd = "$modelRoot/tools/uniquification/scripts/uniquify.pl ";
$cmd .= " -prefix $prefix";
$cmd .= " -model_root $modelRoot";
$cmd .= " -f tools/uniquification/inputs/$ENV{CLUSTER}.puni_switches.txt";
$cmd .= " $checker_mode";
$cmd .= " $enable_git_mv";
0 == system($cmd) or die "Error in puni-based uniquificiation";
if ($checker_mode eq "-checker_mode" && $enable_git_mv eq 'enable_git_mv') {
    print "-I- Run \$source tools/uniquification/outputs/gitmv_command.list from model root to perform git mv, then commit changes.\n";
}

if ($checker_mode ne "-checker_mode") {
  #Post-processing for items not handled by PUNI
  #my $cmd = "$modelRoot/tools/uniquification/scripts/uniquifyme_custom.csh $modelRoot $prefix";
  #0 == system($cmd) or die "Error in custom uniquification uniquificiation";
}

print "-I- Done\n"
