#
# Copyright 2000-2003 Asynchronous Digital Design.  All rights reserved.
#
# $Id$
#
# Author: Jesse Rosenstock
# Version:  $Name:  $ $Date$
#

# Make settings
# Clean out default rules.  We don't want them.
.SUFFIXES:

# Phony rules
.PHONY: all extraclean clean install default help test javadoc
.PHONY: test_no_build install_jar install_ext2aspice install_iosim
.PHONY: cleandoc makefiles dsim_clean dsim install_dsim install_jflat
.PHONY: install_jlvs install_cadencize install_cdl2aspice remove_stale
.PHONY: some %/some


#default rule to build.
default: clean all test


# locations.
CHECKOUT=/home/lines
JCAST:=$(shell pwd)
space:= $(empty) $(empty)

CLASSES_DIR:=classes
JRE_LIB:=/usr/intel/pkgs/java/1.6.0.10-64/jre/lib
JRE_JARS:=$(JRE_LIB)/rt.jar:$(subst $(space),:,$(wildcard $(JRE_LIB)/ext/*.jar))

ifndef CLASSPATH
    export CLASSPATH:=$(JAVAFILES_CLASSES_JAR_ROOT)/antlr-2.7.2.jar:CLASSPATH:=$(JAVAFILES_CLASSES_JAR_ROOT)/concurrent.jar:jars/javancss.jar:jars/jcsp-std-J2.jar:src:$(CLASSES_DIR)
else
    export CLASSPATH:=src:$(CLASSES_DIR):$(CLASSPATH)
endif

UNAME:=$(shell uname)

ifeq ($(UNAME),Darwin)
    export JIKESPATH:=$(CLASSPATH):$(subst $(space),:,$(wildcard /System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Classes/*.jar))
else
    export JIKESPATH:=$(CLASSPATH):$(JRE_JARS)
endif

# programs to use.
# JAVADEPENDS:=jikes +M +P # does not yet work.
ifeq ($(UNAME),Darwin)
    JAVAC ?= jikes +Pno-modifier-order -source 1.4
else
    JAVAC ?= jikes +Pno-modifier-order +Pno-unchecked-exception -source 1.4
endif
JAVA=java
JAVAH=javah
JAVAC_FLAGS=-g -d classes
ANTLR=java antlr.Tool
CTAGS:=ctags
INSTALL = install -m 775
SED=sed

#JAVADOC=scripts/javadoc-1.2
JAVADOC_CLASSPATH := jars/antlrall-2.7.2.jar:$(CLASSPATH)
JAVADOC:=javadoc -source 1.4 -classpath $(JAVADOC_CLASSPATH)
JAVADOC_FLAGS:=-private -version -author -breakiterator -splitindex \
    -windowtitle "jcast javadoc" \
    -tag todo:a:"To Do:" -tag design:a:"Design Note:" \
    -tag review:a:"Should be Reviewed:" -tag bug:a:"Possible Bug:" \
    -link http://java.sun.com/j2se/1.3/docs/api/ \
    -link http://internal.avlsi.com/technical/docs/antlr-docs \
    -link http://internal.avlsi.com/technical/docs/jcsp-docs
JAVADOC_DIR=javadoc

FIND_JAVA_FILES:=find src -name '*.java'
FIND_CLASS_FILES:=find classes -name '*.class'
FIND_ANTLR_FILES:=find src -name '*.g'
REALIGNORES:=$(find src -name '.realignore')

SUBDIRS:=$(shell find src -type d)
SUBDIR_MAKEFILES:=$(SUBDIRS:%=%/Makefile)


#build directory
BUILD := $(JCAST)/build

ANTLR_SOURCES:=$(shell $(FIND_ANTLR_FILES))
# ANTLR_TARGETS:=$(ANTLR_SOURCES:%.g=%Parser.java) \
#    $(ANTLR_SOURCES:%.g=%TokenTypes.java) \
#    $(ANTLR_SOURCES:%.g=%Lexer.java)
#
# Not all of them produced.  *sigh*
ANTLR_TARGETS := 


#Get all antlr rules from file in make files fragments in the build directory.
ANTLR_GRAMMER_BUILD_INCLUDES := $(wildcard $(BUILD)/antlr-grammers/*/antlrrules.mk)

include $(ANTLR_GRAMMER_BUILD_INCLUDES)


# Produced when grammars extend each other
ANTLR_BYPRODUCTS:=\
    src/com/avlsi/cast2/impl/extendedCastPrs.g\
    src/com/avlsi/cast2/impl/extendedCastSubcells.g

ALL_CVS_JAVA_FILES:=$(filter-out $(ANTLR_TARGETS), $(shell $(FIND_JAVA_FILES)))
ALL_JAVA_FILES:=$(ALL_CVS_JAVA_FILES) $(ANTLR_TARGETS)
ALL_CLASS_FILES:=$(ALL_JAVA_FILES:src/%.java=classes/%.class)

BUILD_INFRASTRUCTURE:=$(SUBDIR_MAKEFILES)


help:
	@echo '"make" rebuilds all stale .class files in large batches'
	@echo '"make clean" removes all .class files'
	@echo '"make extraclean" also removes autogenerated Makefiles, and dependancy (.u) files'
	@echo '"make makefiles" rebuilds Makefiles in all dirs'
	@echo '"make javadoc" builds javadoc in' "$(JAVADOC_DIR)"
	@echo '"make cleandoc" removes' "$(JAVADOC_DIR)"
	@echo '"make test" runs tests'
	@echo '"make tags" makes a "tags" file. (vim -t identifier) jumps to it.'
	@echo '"make install" installs jars'
	@echo '"make install_dsim" installs dsim shared library'

all: $(BUILD_INFRASTRUCTURE) $(ANTLR_TARGETS) $(ALL_CLASS_FILES)

tags: $(BUILD_INFRASTRUCTURE) $(ALL_JAVA_FILES)
	$(FIND_JAVA_FILES) -print | $(CTAGS) -L-

%/tags: $(BUILD_INFRASTRUCTURE) $(ANTLR_TARGETS)
	cd `dirname "$@"` && $(CTAGS) *.java

clean:
	rm -rf apps-build
	find classes -name '*.class' -print0 | xargs -0 rm -f
	find src     -name '*.class' -print0 | xargs -0 rm -f

extraclean: clean
	-rm -f $(BUILD_INFRASTRUCTURE)
	-rm -f $(ANTLR_TARGETS)
	-rm -f $(ANTLR_BYPRODUCTS)
	find classes -name '*.u' -print0 | xargs -0 rm -f
	find . -name 'tags' -print0 | xargs -0 rm -f

# installation

install: all install_jar install_ext2aspice install_iosim install_jflat \
    install_cadencize install_jlvs install_cdl2aspice install_csp2java
	@echo "libDSIMServer.so not installed, make install_dsim to install"

install_jar: jcast.jar
	$(INSTALL) jcast.jar jars/jcast.jar

install_ext2aspice: scripts/ext2aspice
	$(INSTALL) scripts/ext2aspice /usr/local/cad/bin/java_ext2aspice

install_cdl2aspice: scripts/cdl2aspice
	$(INSTALL) scripts/cdl2aspice /usr/local/cad/bin/java_cdl2aspice

install_cadencize: scripts/cadencize
	$(INSTALL) scripts/cadencize /usr/local/cad/bin/cadencize

install_jflat: scripts/jflat
	$(INSTALL) scripts/jflat /usr/local/cad/bin/jflat

install_jlvs: scripts/jlvs
	$(INSTALL) scripts/jlvs /usr/local/cad/bin/jlvs

install_iosim: scripts/iosim
	$(INSTALL) scripts/iosim /usr/local/cad/bin/iosim

install_mgn: scripts/mgn
	$(INSTALL) scripts/mgn /usr/local/cad/bin/mgn

install_csp2java: jcast.jar scripts/csp2java
	$(INSTALL) scripts/csp2java /usr/local/cad/bin/csp2java
	$(INSTALL) jcast.jar jars/csp2java.jar

jcast.jar: all
	jar cf jcast.jar -C classes .

$(CLASSES_DIR):
	mkdir $(CLASSES_DIR)

# Excluding cmdline/ is a hack to get rid of the javadoc error
# produced there so javadoc can actually be generated.
javadoc: cleandoc
	mkdir $(JAVADOC_DIR)
	$(JAVADOC) $(JAVADOC_FLAGS) -d $(JAVADOC_DIR) \
	    `$(FIND_JAVA_FILES) -and -not -path '*com/avlsi/util/cmdline/*' \
	    -exec dirname '{}' \; | sort | uniq | \
	    $(SED) 's:src/::; s:/:.:g;' `

cleandoc:
	rm -rf $(JAVADOC_DIR)

test: all
	$(JAVA) com.avlsi.test.TestEverything

makefiles: $(SUBDIR_MAKEFILES)

$(SUBDIR_MAKEFILES): scripts/make_subdir_makefile
	scripts/make_subdir_makefile `dirname $@`

%/some:
	$(JAVAC) $(JAVAC_FLAGS) $(*)/*.java

# rules for java
# Can not compile some of these until the ANTLR targets they reference
# get made.
$(ALL_CLASS_FILES) : $(ANTLR_TARGETS) $(CLASSES_DIR)

ifdef JAVADEPENDS
###
# Okay, this is tricky...
# We want to batch up compilations to minimize time spent starting
# up the compiler. OTOH, we also don't want to compile java files
# unnecessarily. So, we want make to compile all things that are
# out-of-date whenever any one thing is out-of-date.
# We can do this by having make invoke itself to collect the list of
# files to compile, and only then compiling them.
ifndef JAVA_MAKE_COLLECTION_HACK
classes/%.class classes/%.u : src/%.java
	: > collecting
	make JAVA_MAKE_COLLECTION_HACK=1 all
	sort < collecting | uniq > out-of-date
	$(JAVADEPENDS) $(JAVAC_FLAGS) @out-of-date
	rm out-of-date collecting
else
# should also remove all inner classes here.
classes/%.class classes/%.u : src/%.java
	@echo -n .
	@echo $< >> collecting
endif

# - -- do not complain if missing
# $(wildcard ...) -- only use pre-existing depends.  Otherwise make
# will try to build them.
ifneq (,$(wildcard $(ALL_CLASS_FILES:%.class=%.u)))
-include $(wildcard $(ALL_CLASS_FILES:%.class=%.u))
endif
else
####
# not trying to save time with dependencies.  All class files get rebuilt when anything changes.
$(ALL_CLASS_FILES) : $(ALL_JAVA_FILES) $(CLASSES_DIR)
	@[ -z "$(MAKE_DEBUG)" ] || echo compiling $(@:classes/%.class=src/%.java)
	$(FIND_JAVA_FILES) -print0 | xargs -0 $(JAVAC) $(JAVAC_FLAGS)
endif

# We start with a list of all extant .class files, and remove the ones
# we think we can generate from the list of java files. This skips inner
# classes that may have been eliminated, but we will handle those cases
# in building.
#
remove_stale:
	-rm -f $(filter-out $(ALL_JAVA_FILES:src/%.java=classes/%.class) $(ALL_JAVA_FILES:src/%.java=classes/%$*.class), $(shell $(FIND_CLASS_FILES)))

# DSIM Stuff

DSIMOBJ=src/com/avlsi/dsim/DSIMServer.o \
	$(CHECKOUT)/cast/aspice/source/obj.i686/dsimlib.o \
	$(CHECKOUT)/cast/aspice/source/obj.i686/aspicelib.a \
	$(CHECKOUT)/cast/lib/obj.i686/castlib.a

src/com/avlsi/dsim/com_avlsi_dsim_DSIMServer.h: classes/com/avlsi/dsim/DSIMServer.class
	$(JAVAH) -jni -o $@ com.avlsi.dsim.DSIMServer

src/com/avlsi/dsim/DSIMServer.o: src/com/avlsi/dsim/DSIMServer.c src/com/avlsi/dsim/com_avlsi_dsim_DSIMServer.h
	$(CC) -Wall -I$(CHECKOUT)/cast/aspice/source -I/usr/local/java/include -Isrc/com/avlsi/dsim -c src/com/avlsi/dsim/DSIMServer.c -o $@

src/com/avlsi/dsim/libDSIMServer.so: $(DSIMOBJ)
	$(CC) -shared -Wl,-soname,libDSIMServe.so -o $@ $(DSIMOBJ)

dsim_clean:
	-rm -rf src/com/avlsi/dsim/DSIMServer.o src/com/avlsi/dsim/libDSIMServer.so src/com/avlsi/dsim/com_avlsi_dsim_DSIMServer.h

dsim: all src/com/avlsi/dsim/libDSIMServer.so

install_dsim: dsim
	cp src/com/avlsi/dsim/libDSIMServer.so jars/native

CPPFLAGS=-I/usr/local/java/include  -I/usr/local/java/include/linux  -I/usr/local/java/include/solaris  -I/usr/include
include src/com/avlsi/util/readline/submakefile
include src/com/avlsi/util/cmdline/submakefile
include src/com/avlsi/tools/tsim/denali/submakefile


# Import rules for building applications
APPS_TARGET_DIRS := apps-build



APP_BUILD_INCLUDES := $(wildcard $(BUILD)/apps/*/apprules.mk)
APP_BUILD_BASE_CLASSPATH := $(JRE_JARS)
include $(APP_BUILD_INCLUDES)
